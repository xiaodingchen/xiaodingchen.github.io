<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.66" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://www.ixlymsy.top/redis/redis-data-structure.html"><meta property="og:site_name" content="ä¸ªäººæˆé•¿å…¨è®°å½•-ç è¯´256"><meta property="og:title" content="Redisä¸­çš„æ•°æ®ç»“æ„"><meta property="og:description" content="åŸæ–‡åœ°å€ Redisä¸­çš„æ•°æ®ç»“æ„ (https://www.cnblogs.com/neooelric/p/9621736.html) 1. åº•å±‚æ•°æ®ç»“æ„, ä¸Redis Value Typeä¹‹é—´çš„å…³ç³» å¯¹äºRedisçš„ä½¿ç”¨è€…æ¥è¯´, Redisä½œä¸ºKey-Valueå‹çš„å†…å­˜æ•°æ®åº“, å…¶Valueæœ‰å¤šç§ç±»å‹. String; Hash; List; Se..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-07-14T13:51:32.000Z"><meta property="article:author" content="ç è¯´256"><meta property="article:tag" content="redis"><meta property="article:tag" content="é¢è¯•"><meta property="article:tag" content="é¢è¯•æ€»ç»“"><meta property="article:modified_time" content="2023-07-14T13:51:32.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Redisä¸­çš„æ•°æ®ç»“æ„","image":[""],"dateModified":"2023-07-14T13:51:32.000Z","author":[{"@type":"Person","name":"ç è¯´256","url":"https://www.ixlymsy.top"}]}</script><title>Redisä¸­çš„æ•°æ®ç»“æ„ | ä¸ªäººæˆé•¿å…¨è®°å½•-ç è¯´256</title><meta name="description" content="åŸæ–‡åœ°å€ Redisä¸­çš„æ•°æ®ç»“æ„ (https://www.cnblogs.com/neooelric/p/9621736.html) 1. åº•å±‚æ•°æ®ç»“æ„, ä¸Redis Value Typeä¹‹é—´çš„å…³ç³» å¯¹äºRedisçš„ä½¿ç”¨è€…æ¥è¯´, Redisä½œä¸ºKey-Valueå‹çš„å†…å­˜æ•°æ®åº“, å…¶Valueæœ‰å¤šç§ç±»å‹. String; Hash; List; Se...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-3401b203.css" as="style"><link rel="stylesheet" href="/assets/style-3401b203.css">
    <link rel="modulepreload" href="/assets/app-23d1540c.js"><link rel="modulepreload" href="/assets/redis-data-structure.html-f17ec180.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="modulepreload" href="/assets/redis-data-structure.html-59274fd6.js"><link rel="prefetch" href="/assets/index.html-922fd467.js" as="script"><link rel="prefetch" href="/assets/css.html-b21625c4.js" as="script"><link rel="prefetch" href="/assets/channel.html-56bc92db.js" as="script"><link rel="prefetch" href="/assets/gin1.html-f70aec91.js" as="script"><link rel="prefetch" href="/assets/go-gpm.html-84092e76.js" as="script"><link rel="prefetch" href="/assets/go-scheduler-base.html-ab2c0534.js" as="script"><link rel="prefetch" href="/assets/map1.html-80822925.js" as="script"><link rel="prefetch" href="/assets/map2.html-3c6862cf.js" as="script"><link rel="prefetch" href="/assets/mux1.html-d00b7c2b.js" as="script"><link rel="prefetch" href="/assets/slice1.html-afc59263.js" as="script"><link rel="prefetch" href="/assets/mysql-index-b-plus.html-e3bf5f3d.js" as="script"><link rel="prefetch" href="/assets/mysql-interview.html-e15234c1.js" as="script"><link rel="prefetch" href="/assets/mysql-mvcc.html-afb62414.js" as="script"><link rel="prefetch" href="/assets/mysql1.html-fd732ed4.js" as="script"><link rel="prefetch" href="/assets/mysql2.html-057df47a.js" as="script"><link rel="prefetch" href="/assets/mysql3.html-763e2f0e.js" as="script"><link rel="prefetch" href="/assets/interview1.html-25acba31.js" as="script"><link rel="prefetch" href="/assets/redis-basic.html-8c1e52da.js" as="script"><link rel="prefetch" href="/assets/redis-cache-things.html-aa1b2d73.js" as="script"><link rel="prefetch" href="/assets/redis-master-slave.html-d07fc20c.js" as="script"><link rel="prefetch" href="/assets/redis-mem.html-44f8ce2d.js" as="script"><link rel="prefetch" href="/assets/redis-policy.html-c787cfc1.js" as="script"><link rel="prefetch" href="/assets/redis-rdb.html-572e9eeb.js" as="script"><link rel="prefetch" href="/assets/docker-ignore.html-a8fcccc7.js" as="script"><link rel="prefetch" href="/assets/docker-log-clean.html-d3900bbc.js" as="script"><link rel="prefetch" href="/assets/ruoyi-nginx-web.html-81e17d0f.js" as="script"><link rel="prefetch" href="/assets/ruoyi-nginx.html-7964605e.js" as="script"><link rel="prefetch" href="/assets/index.html-3f7f8c20.js" as="script"><link rel="prefetch" href="/assets/q001.html-8e389a13.js" as="script"><link rel="prefetch" href="/assets/q002.html-c0c829db.js" as="script"><link rel="prefetch" href="/assets/q003.html-4220f483.js" as="script"><link rel="prefetch" href="/assets/q004.html-809539b3.js" as="script"><link rel="prefetch" href="/assets/q005.html-70b6b7d8.js" as="script"><link rel="prefetch" href="/assets/q006.html-27d981e9.js" as="script"><link rel="prefetch" href="/assets/q007.html-c781cb31.js" as="script"><link rel="prefetch" href="/assets/q008.html-e8cab93e.js" as="script"><link rel="prefetch" href="/assets/q009.html-fd757ae6.js" as="script"><link rel="prefetch" href="/assets/q010.html-43826eb8.js" as="script"><link rel="prefetch" href="/assets/q011.html-bbcab30b.js" as="script"><link rel="prefetch" href="/assets/q012.html-c2544b0e.js" as="script"><link rel="prefetch" href="/assets/q013.html-e14d5842.js" as="script"><link rel="prefetch" href="/assets/q014.html-29e78c8f.js" as="script"><link rel="prefetch" href="/assets/q015.html-f82061e2.js" as="script"><link rel="prefetch" href="/assets/q016.html-f4e54281.js" as="script"><link rel="prefetch" href="/assets/q017.html-e6600f3d.js" as="script"><link rel="prefetch" href="/assets/q018.html-be5c0827.js" as="script"><link rel="prefetch" href="/assets/q019.html-c72f9ed6.js" as="script"><link rel="prefetch" href="/assets/q020.html-46b9b293.js" as="script"><link rel="prefetch" href="/assets/q021.html-143bcf92.js" as="script"><link rel="prefetch" href="/assets/q022.html-d98b0f93.js" as="script"><link rel="prefetch" href="/assets/404.html-f436630f.js" as="script"><link rel="prefetch" href="/assets/index.html-b8532a1a.js" as="script"><link rel="prefetch" href="/assets/index.html-ea7bc083.js" as="script"><link rel="prefetch" href="/assets/index.html-12a72a9d.js" as="script"><link rel="prefetch" href="/assets/index.html-f426ccc2.js" as="script"><link rel="prefetch" href="/assets/index.html-2d516e00.js" as="script"><link rel="prefetch" href="/assets/index.html-ebb5a7cb.js" as="script"><link rel="prefetch" href="/assets/index.html-6838ed1f.js" as="script"><link rel="prefetch" href="/assets/index.html-d388366c.js" as="script"><link rel="prefetch" href="/assets/index.html-f3228ffb.js" as="script"><link rel="prefetch" href="/assets/index.html-3930c269.js" as="script"><link rel="prefetch" href="/assets/index.html-a3e7c6a2.js" as="script"><link rel="prefetch" href="/assets/index.html-370a637c.js" as="script"><link rel="prefetch" href="/assets/index.html-5248b738.js" as="script"><link rel="prefetch" href="/assets/index.html-af09bfde.js" as="script"><link rel="prefetch" href="/assets/index.html-17d8ccc7.js" as="script"><link rel="prefetch" href="/assets/index.html-09ccade7.js" as="script"><link rel="prefetch" href="/assets/index.html-af0783b2.js" as="script"><link rel="prefetch" href="/assets/index.html-a056508c.js" as="script"><link rel="prefetch" href="/assets/index.html-aaeaedee.js" as="script"><link rel="prefetch" href="/assets/index.html-854468ab.js" as="script"><link rel="prefetch" href="/assets/index.html-bd12a324.js" as="script"><link rel="prefetch" href="/assets/index.html-969e50dd.js" as="script"><link rel="prefetch" href="/assets/index.html-f556bdcc.js" as="script"><link rel="prefetch" href="/assets/index.html-e0b5ee80.js" as="script"><link rel="prefetch" href="/assets/index.html-0343f13d.js" as="script"><link rel="prefetch" href="/assets/index.html-ea512c41.js" as="script"><link rel="prefetch" href="/assets/index.html-2ac1bd2f.js" as="script"><link rel="prefetch" href="/assets/index.html-19de9490.js" as="script"><link rel="prefetch" href="/assets/index.html-03a0eba2.js" as="script"><link rel="prefetch" href="/assets/index.html-c641581c.js" as="script"><link rel="prefetch" href="/assets/index.html-c95be32e.js" as="script"><link rel="prefetch" href="/assets/index.html-e65aa1a0.js" as="script"><link rel="prefetch" href="/assets/index.html-bd24f074.js" as="script"><link rel="prefetch" href="/assets/index.html-df6c7292.js" as="script"><link rel="prefetch" href="/assets/index.html-688ffbe1.js" as="script"><link rel="prefetch" href="/assets/index.html-925b173f.js" as="script"><link rel="prefetch" href="/assets/index.html-920bf324.js" as="script"><link rel="prefetch" href="/assets/index.html-12a919ca.js" as="script"><link rel="prefetch" href="/assets/index.html-e8ce1c80.js" as="script"><link rel="prefetch" href="/assets/index.html-67b749c8.js" as="script"><link rel="prefetch" href="/assets/index.html-875f5f54.js" as="script"><link rel="prefetch" href="/assets/index.html-94ceb22a.js" as="script"><link rel="prefetch" href="/assets/index.html-a192210a.js" as="script"><link rel="prefetch" href="/assets/css.html-12f147e9.js" as="script"><link rel="prefetch" href="/assets/channel.html-193d2513.js" as="script"><link rel="prefetch" href="/assets/gin1.html-230824aa.js" as="script"><link rel="prefetch" href="/assets/go-gpm.html-cf971b73.js" as="script"><link rel="prefetch" href="/assets/go-scheduler-base.html-149845e0.js" as="script"><link rel="prefetch" href="/assets/map1.html-8139113a.js" as="script"><link rel="prefetch" href="/assets/map2.html-f70ce77b.js" as="script"><link rel="prefetch" href="/assets/mux1.html-46111e70.js" as="script"><link rel="prefetch" href="/assets/slice1.html-51cad7b7.js" as="script"><link rel="prefetch" href="/assets/mysql-index-b-plus.html-0fbbeae7.js" as="script"><link rel="prefetch" href="/assets/mysql-interview.html-b9c9eb2c.js" as="script"><link rel="prefetch" href="/assets/mysql-mvcc.html-f3b850c7.js" as="script"><link rel="prefetch" href="/assets/mysql1.html-ea261248.js" as="script"><link rel="prefetch" href="/assets/mysql2.html-c4f20516.js" as="script"><link rel="prefetch" href="/assets/mysql3.html-ad6d0b55.js" as="script"><link rel="prefetch" href="/assets/interview1.html-ed501bc1.js" as="script"><link rel="prefetch" href="/assets/redis-basic.html-f6b10e07.js" as="script"><link rel="prefetch" href="/assets/redis-cache-things.html-d7f82e59.js" as="script"><link rel="prefetch" href="/assets/redis-master-slave.html-3ebfd629.js" as="script"><link rel="prefetch" href="/assets/redis-mem.html-0dcd63ca.js" as="script"><link rel="prefetch" href="/assets/redis-policy.html-60717eeb.js" as="script"><link rel="prefetch" href="/assets/redis-rdb.html-b2c96e5e.js" as="script"><link rel="prefetch" href="/assets/docker-ignore.html-8401a01d.js" as="script"><link rel="prefetch" href="/assets/docker-log-clean.html-09a8b6b1.js" as="script"><link rel="prefetch" href="/assets/ruoyi-nginx-web.html-417bf90a.js" as="script"><link rel="prefetch" href="/assets/ruoyi-nginx.html-2a1f0731.js" as="script"><link rel="prefetch" href="/assets/index.html-8e7684c2.js" as="script"><link rel="prefetch" href="/assets/q001.html-e52cb5d1.js" as="script"><link rel="prefetch" href="/assets/q002.html-a352ad54.js" as="script"><link rel="prefetch" href="/assets/q003.html-78604f43.js" as="script"><link rel="prefetch" href="/assets/q004.html-c0e7db2b.js" as="script"><link rel="prefetch" href="/assets/q005.html-a5630039.js" as="script"><link rel="prefetch" href="/assets/q006.html-7f0ab1d3.js" as="script"><link rel="prefetch" href="/assets/q007.html-7b20307d.js" as="script"><link rel="prefetch" href="/assets/q008.html-7be07723.js" as="script"><link rel="prefetch" href="/assets/q009.html-9c13a637.js" as="script"><link rel="prefetch" href="/assets/q010.html-07b6aee0.js" as="script"><link rel="prefetch" href="/assets/q011.html-f8494b77.js" as="script"><link rel="prefetch" href="/assets/q012.html-0daf9a09.js" as="script"><link rel="prefetch" href="/assets/q013.html-6f11e2b8.js" as="script"><link rel="prefetch" href="/assets/q014.html-1dfd463a.js" as="script"><link rel="prefetch" href="/assets/q015.html-ebb5b1f1.js" as="script"><link rel="prefetch" href="/assets/q016.html-007c901f.js" as="script"><link rel="prefetch" href="/assets/q017.html-943cf04b.js" as="script"><link rel="prefetch" href="/assets/q018.html-79603ed6.js" as="script"><link rel="prefetch" href="/assets/q019.html-171d276a.js" as="script"><link rel="prefetch" href="/assets/q020.html-9d56dcb6.js" as="script"><link rel="prefetch" href="/assets/q021.html-5cd26e78.js" as="script"><link rel="prefetch" href="/assets/q022.html-da38fc31.js" as="script"><link rel="prefetch" href="/assets/404.html-a23197da.js" as="script"><link rel="prefetch" href="/assets/index.html-405a35ec.js" as="script"><link rel="prefetch" href="/assets/index.html-dc3dc710.js" as="script"><link rel="prefetch" href="/assets/index.html-9f6e473f.js" as="script"><link rel="prefetch" href="/assets/index.html-03b91847.js" as="script"><link rel="prefetch" href="/assets/index.html-da08583b.js" as="script"><link rel="prefetch" href="/assets/index.html-fc022083.js" as="script"><link rel="prefetch" href="/assets/index.html-290512f6.js" as="script"><link rel="prefetch" href="/assets/index.html-e7d95b8f.js" as="script"><link rel="prefetch" href="/assets/index.html-00be96f6.js" as="script"><link rel="prefetch" href="/assets/index.html-62bda041.js" as="script"><link rel="prefetch" href="/assets/index.html-e3829f30.js" as="script"><link rel="prefetch" href="/assets/index.html-09d78ffa.js" as="script"><link rel="prefetch" href="/assets/index.html-ba69863f.js" as="script"><link rel="prefetch" href="/assets/index.html-4e37150d.js" as="script"><link rel="prefetch" href="/assets/index.html-ef608082.js" as="script"><link rel="prefetch" href="/assets/index.html-0a6f2472.js" as="script"><link rel="prefetch" href="/assets/index.html-5834afed.js" as="script"><link rel="prefetch" href="/assets/index.html-84d3abc6.js" as="script"><link rel="prefetch" href="/assets/index.html-bb048a2a.js" as="script"><link rel="prefetch" href="/assets/index.html-b5160f99.js" as="script"><link rel="prefetch" href="/assets/index.html-4b98553b.js" as="script"><link rel="prefetch" href="/assets/index.html-e3117177.js" as="script"><link rel="prefetch" href="/assets/index.html-a771085c.js" as="script"><link rel="prefetch" href="/assets/index.html-4030c60f.js" as="script"><link rel="prefetch" href="/assets/index.html-67b6516f.js" as="script"><link rel="prefetch" href="/assets/index.html-3388b29c.js" as="script"><link rel="prefetch" href="/assets/index.html-21d4ce08.js" as="script"><link rel="prefetch" href="/assets/index.html-19389ec6.js" as="script"><link rel="prefetch" href="/assets/index.html-a38cfbc7.js" as="script"><link rel="prefetch" href="/assets/index.html-32e04ea8.js" as="script"><link rel="prefetch" href="/assets/index.html-b9e04fd7.js" as="script"><link rel="prefetch" href="/assets/index.html-1ecfedf8.js" as="script"><link rel="prefetch" href="/assets/index.html-eee83ca8.js" as="script"><link rel="prefetch" href="/assets/index.html-87ce81e5.js" as="script"><link rel="prefetch" href="/assets/index.html-c9f98c0d.js" as="script"><link rel="prefetch" href="/assets/index.html-a3f2572b.js" as="script"><link rel="prefetch" href="/assets/index.html-36277a94.js" as="script"><link rel="prefetch" href="/assets/index.html-5a78011c.js" as="script"><link rel="prefetch" href="/assets/index.html-c838fbcd.js" as="script"><link rel="prefetch" href="/assets/index.html-499d2722.js" as="script"><link rel="prefetch" href="/assets/index.html-e8d293b2.js" as="script"><link rel="prefetch" href="/assets/index.html-9190a6db.js" as="script"><link rel="prefetch" href="/assets/giscus-765fdce2.js" as="script"><link rel="prefetch" href="/assets/auto-fa8841cf.js" as="script"><link rel="prefetch" href="/assets/index-a7d1ee58.js" as="script"><link rel="prefetch" href="/assets/flowchart-c441f34d.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-b767ba60.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-75b11b9d.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-abe06b83.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-a106bb2c.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-ec5549c1.js" as="script"><link rel="prefetch" href="/assets/search.esm-7e6792e2.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/VuePlayground-8135bd92.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-5794cde2.js" as="script"><link rel="prefetch" href="/assets/SearchResult-afd3b3b3.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.png" alt="ä¸ªäººæˆé•¿å…¨è®°å½•-ç è¯´256"><!----><span class="vp-site-name hide-in-pad">ä¸ªäººæˆé•¿å…¨è®°å½•-ç è¯´256</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>é¦–é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/golang/"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>Golang<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/php/"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>PHP<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/mysql/"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>MySQL<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link active" href="/redis/"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>Redis<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/fe/"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>å‰ç«¯<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/yunwei/"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>è¿ç»´<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/tag/%E9%9D%A2%E8%AF%95/"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>é¢è¯•æ€»ç»“<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><!----><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" role="search" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">æœç´¢</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>é¦–é¡µ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Golang</span><!----></p><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/golang/gin1.html"><!---->Golangé€šè¿‡Ginæ¡†æ¶åˆ›å»ºhttpæœåŠ¡æºç å‰–æ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/golang/slice1.html"><!---->Goé¢è¯•ä¹‹Slice<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/golang/map1.html"><!---->Goé¢è¯•ä¹‹mapã€structã€interface<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/golang/map2.html"><!---->Goé¢è¯•ä¹‹å¹¶å‘å®‰å…¨çš„map<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/golang/channel.html"><!---->Goé¢è¯•ä¹‹Channelçš„ä½¿ç”¨<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/golang/mux1.html"><!---->Goé¢è¯•ä¹‹sync.Mutexå’Œsync.RWMutex<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/golang/go-scheduler-base.html"><!---->goroutineè°ƒåº¦å™¨æ¦‚è¿°<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/golang/go-gpm.html"><!---->Goè¯­è¨€çš„GPMè°ƒåº¦å™¨æ˜¯ä»€ä¹ˆï¼Ÿ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Golang å¸¸è§é¢è¯•é¢˜ç›®è§£æ</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">PHP</span><!----></p><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/php/interview1.html"><!---->PHPé¢è¯•æ€»ç»“ v20180824<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">MySQL</span><!----></p><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/mysql/mysql1.html"><!---->MySQLç›¸å…³çŸ¥è¯†ç‚¹æµ…æ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/mysql/mysql2.html"><!---->MySQLç¬”è®°ä¹‹åŸºç¡€ç¯‡<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/mysql/mysql3.html"><!---->MySQLç¬”è®°ä¹‹å®è·µç¯‡<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/mysql/mysql-interview.html"><!---->MySQLæ•°æ®åº“ç»å…¸é¢è¯•é¢˜è§£æ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/mysql/mysql-mvcc.html"><!---->MySQL InnoDB MVCC æœºåˆ¶çš„åŸç†åŠå®ç°<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/mysql/mysql-index-b-plus.html"><!---->ä¸ºä»€ä¹ˆMySQLä½¿ç”¨B+æ ‘åšç´¢å¼•ï¼Ÿ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading active"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Redis</span><!----></p><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/redis/redis-basic.html"><!---->Redis åŸºç¡€<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/redis/redis-data-structure.html"><!---->Redisä¸­çš„æ•°æ®ç»“æ„<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/redis/redis-data-structure.html#_1-åº•å±‚æ•°æ®ç»“æ„-ä¸redis-value-typeä¹‹é—´çš„å…³ç³»"><!---->1. åº•å±‚æ•°æ®ç»“æ„, ä¸Redis Value Typeä¹‹é—´çš„å…³ç³»<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/redis/redis-data-structure.html#_2-åº•å±‚æ•°æ®ç»“æ„"><!---->2. åº•å±‚æ•°æ®ç»“æ„<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/redis/redis-data-structure.html#_2-1-sds-simple-dynamic-string"><!---->2.1 SDS - simple dynamic string<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/redis/redis-data-structure.html#_2-2-list"><!---->2.2 list<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/redis/redis-data-structure.html#_2-3-dict"><!---->2.3 dict<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/redis/redis-data-structure.html#_2-4-zskiplist"><!---->2.4 zskiplist<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/redis/redis-data-structure.html#_2-5-intset"><!---->2.5 intset<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/redis/redis-data-structure.html#_2-6-ziplist"><!---->2.6 ziplist<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/redis/redis-data-structure.html#_2-7-quicklist"><!---->2.7 quicklist<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/redis/redis-data-structure.html#_2-8-zipmap"><!---->2.8 zipmap<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/redis/redis-master-slave.html"><!---->Redisä¸»ä»å¤åˆ¶åŸç†<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/redis/redis-policy.html"><!---->Redisä¸­å†…å­˜æ·˜æ±°ç®—æ³•å®ç°<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/redis/redis-rdb.html"><!---->RedisæŒä¹…åŒ–çš„åŸç†åŠä¼˜åŒ–<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/redis/redis-mem.html"><!---->Rediså†…å­˜åˆ†æ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/redis/redis-cache-things.html"><!---->ç¼“å­˜ç³»ç»Ÿä¸­é¢ä¸´çš„é›ªå´©/ç©¿é€/ä¸€è‡´æ€§é—®é¢˜<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">å‰ç«¯</span><!----></p><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/fe/css.html"><!---->æ–‡æœ¬è¶…å‡ºå®½åº¦çœç•¥å·<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">è¿ç»´</span><!----></p><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/yunwei/ruoyi-nginx.html"><!---->è‹¥ä¾å‰ç«¯é…ç½®<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/yunwei/docker-ignore.html"><!---->dockerå¿½ç•¥ç›¸å…³æ–‡ä»¶<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/yunwei/docker-log-clean.html"><!---->dockeræ¸…ç†æ—¥å¿—<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/yunwei/ruoyi-nginx-web.html"><!---->è‹¥ä¾Nginxé…ç½®ç¤ºä¾‹<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Redisä¸­çš„æ•°æ®ç»“æ„</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://www.ixlymsy.top" target="_blank" rel="noopener noreferrer">ç è¯´256</a></span><span property="author" content="ç è¯´256"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-07-14T13:51:32.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 39 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT39M"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category5 clickable" role="navigation">redis</span><!--]--><meta property="articleSection" content="redis"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag5 clickable" role="navigation">redis</span><span class="page-tag-item tag2 clickable" role="navigation">é¢è¯•</span><span class="page-tag-item tag3 clickable" role="navigation">é¢è¯•æ€»ç»“</span><!--]--><meta property="keywords" content="redis,é¢è¯•,é¢è¯•æ€»ç»“"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_1-åº•å±‚æ•°æ®ç»“æ„-ä¸redis-value-typeä¹‹é—´çš„å…³ç³»">1. åº•å±‚æ•°æ®ç»“æ„, ä¸Redis Value Typeä¹‹é—´çš„å…³ç³»</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_2-åº•å±‚æ•°æ®ç»“æ„">2. åº•å±‚æ•°æ®ç»“æ„</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-1-sds-simple-dynamic-string">2.1 SDS - simple dynamic string</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-2-list">2.2 list</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-3-dict">2.3 dict</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-4-zskiplist">2.4 zskiplist</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-5-intset">2.5 intset</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-6-ziplist">2.6 ziplist</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-7-quicklist">2.7 quicklist</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-8-zipmap">2.8 zipmap</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h1 id="redisä¸­çš„æ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#redisä¸­çš„æ•°æ®ç»“æ„" aria-hidden="true">#</a> Redisä¸­çš„æ•°æ®ç»“æ„</h1><p>åŸæ–‡åœ°å€ <a href="https://www.cnblogs.com/neooelric/p/9621736.html" target="_blank" rel="noopener noreferrer">Redisä¸­çš„æ•°æ®ç»“æ„<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="_1-åº•å±‚æ•°æ®ç»“æ„-ä¸redis-value-typeä¹‹é—´çš„å…³ç³»" tabindex="-1"><a class="header-anchor" href="#_1-åº•å±‚æ•°æ®ç»“æ„-ä¸redis-value-typeä¹‹é—´çš„å…³ç³»" aria-hidden="true">#</a> 1. åº•å±‚æ•°æ®ç»“æ„, ä¸Redis Value Typeä¹‹é—´çš„å…³ç³»</h2><p>å¯¹äºRedisçš„ä½¿ç”¨è€…æ¥è¯´, Redisä½œä¸ºKey-Valueå‹çš„å†…å­˜æ•°æ®åº“, å…¶Valueæœ‰å¤šç§ç±»å‹.</p><ul><li>String</li><li>Hash</li><li>List</li><li>Set</li><li>ZSet</li></ul><p>è¿™äº›Valueçš„ç±»å‹, åªæ˜¯&quot;Redisçš„ç”¨æˆ·è®¤ä¸ºçš„, Valueå­˜å‚¨æ•°æ®çš„æ–¹å¼&quot;. è€Œåœ¨å…·ä½“å®ç°ä¸Š, å„ä¸ªTypeçš„Valueåˆ°åº•å¦‚ä½•å­˜å‚¨, è¿™å¯¹äºRedisçš„ä½¿ç”¨è€…æ¥è¯´æ˜¯ä¸å…¬å¼€çš„.</p><p>ä¸¾ä¸ªç²Ÿå­: ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤åˆ›å»ºä¸€ä¸ªKey-Value</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>SET <span class="token string">&quot;Hello&quot;</span> <span class="token string">&quot;World&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å¯¹äºRedisçš„ä½¿ç”¨è€…æ¥è¯´, <code>Hello</code>è¿™ä¸ªKey, å¯¹åº”çš„Valueæ˜¯Stringç±»å‹, å…¶å€¼ä¸ºäº”ä¸ªASCIIå­—ç¬¦ç»„æˆçš„äºŒè¿›åˆ¶æ•°æ®. ä½†å…·ä½“åœ¨åº•å±‚å®ç°ä¸Š, è¿™äº”ä¸ªå­—èŠ‚æ˜¯å¦‚ä½•å­˜å‚¨çš„, æ˜¯ä¸å¯¹ç”¨æˆ·å…¬å¼€çš„. å³, Valueçš„Type, åªæ˜¯è¡¨è±¡, å…·ä½“æ•°æ®åœ¨å†…å­˜ä¸­ä»¥ä½•ç§æ•°æ®ç»“æ„å­˜æ”¾, è¿™å¯¹äºç”¨æˆ·æ¥è¯´æ˜¯ä¸å¿…è¦äº†è§£çš„.</p><p>Rediså¯¹ä½¿ç”¨è€…æš´éœ²äº†äº”ç§<code>Value Type</code>, å…¶åº•å±‚å®ç°çš„æ•°æ®ç»“æ„æœ‰8ç§, åˆ†åˆ«æ˜¯:</p><ul><li>SDS - simple synamic string - æ”¯æŒè‡ªåŠ¨åŠ¨æ€æ‰©å®¹çš„å­—èŠ‚æ•°ç»„</li><li>list - å¹³å¹³æ— å¥‡çš„é“¾è¡¨</li><li>dict - ä½¿ç”¨åŒå“ˆå¸Œè¡¨å®ç°çš„, æ”¯æŒå¹³æ»‘æ‰©å®¹çš„å­—å…¸</li><li>zskiplist - é™„åŠ äº†åå‘æŒ‡é’ˆçš„è·³è·ƒè¡¨</li><li>intset - ç”¨äºå­˜å‚¨æ•´æ•°æ•°å€¼é›†åˆçš„è‡ªæœ‰ç»“æ„</li><li>ziplist - ä¸€ç§å®ç°ä¸Šç±»ä¼¼äºTLV, ä½†æ¯”TLVå¤æ‚çš„, ç”¨äºå­˜å‚¨ä»»æ„æ•°æ®çš„æœ‰åºåºåˆ—çš„æ•°æ®ç»“æ„</li><li>quicklist - ä¸€ç§ä»¥ziplistä½œä¸ºç»“ç‚¹çš„åŒé“¾è¡¨ç»“æ„, å®ç°çš„éå¸¸è‹Ÿ</li><li>zipmap - ä¸€ç§ç”¨äºåœ¨å°è§„æ¨¡åœºåˆä½¿ç”¨çš„è½»é‡çº§å­—å…¸ç»“æ„</li></ul><p>è€Œè¡”æ¥&quot;åº•å±‚æ•°æ®ç»“æ„&quot;ä¸&quot;Value Type&quot;çš„æ¡¥æ¢çš„, åˆ™æ˜¯Rediså®ç°çš„å¦å¤–ä¸€ç§æ•°æ®ç»“æ„: <code>redisObject</code>. Redisä¸­çš„Keyä¸Valueåœ¨è¡¨å±‚éƒ½æ˜¯ä¸€ä¸ª<code>redisObject</code>å®ä¾‹, æ•…è¯¥ç»“æ„æœ‰æ‰€è°“çš„&quot;ç±»å‹&quot;, å³æ˜¯<code>ValueType</code>. å¯¹äºæ¯ä¸€ç§<code>Value Type</code>ç±»å‹çš„<code>redisObject</code>, å…¶åº•å±‚è‡³å°‘æ”¯æŒä¸¤ç§ä¸åŒçš„åº•å±‚æ•°æ®ç»“æ„æ¥å®ç°. ä»¥åº”å¯¹åœ¨ä¸åŒçš„åº”ç”¨åœºæ™¯ä¸­, Redisçš„è¿è¡Œæ•ˆç‡, æˆ–å†…å­˜å ç”¨.</p><h2 id="_2-åº•å±‚æ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_2-åº•å±‚æ•°æ®ç»“æ„" aria-hidden="true">#</a> 2. åº•å±‚æ•°æ®ç»“æ„</h2><h3 id="_2-1-sds-simple-dynamic-string" tabindex="-1"><a class="header-anchor" href="#_2-1-sds-simple-dynamic-string" aria-hidden="true">#</a> 2.1 SDS - simple dynamic string</h3><p>è¿™æ˜¯ä¸€ç§ç”¨äºå­˜å‚¨äºŒè¿›åˆ¶æ•°æ®çš„ä¸€ç§ç»“æ„, å…·æœ‰åŠ¨æ€æ‰©å®¹çš„ç‰¹ç‚¹. å…¶å®ç°ä½äºsrc/sds.hä¸src/sds.cä¸­, å…¶å…³é”®å®šä¹‰å¦‚ä¸‹:</p><div class="language-cgo line-numbers-mode" data-ext="cgo"><pre class="language-cgo"><code>typedef char *sds;

/* Note: sdshdr5 is never used, we just access the flags byte directly.
 * However is here to document the layout of type 5 SDS strings. */
struct __attribute__ ((__packed__)) sdshdr5 {
    unsigned char flags; /* 3 lsb of type, and 5 msb of string length */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr8 {
    uint8_t len; /* used */
    uint8_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr16 {
    uint16_t len; /* used */
    uint16_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr32 {
    uint32_t len; /* used */
    uint32_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr64 {
    uint64_t len; /* used */
    uint64_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>SDSçš„æ€»ä½“æ¦‚è§ˆå¦‚ä¸‹å›¾:</p><figure><img src="data:image/png;base64,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" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å…¶ä¸­sdshdræ˜¯å¤´éƒ¨, bufæ˜¯çœŸå®å­˜å‚¨ç”¨æˆ·æ•°æ®çš„åœ°æ–¹. å¦å¤–æ³¨æ„, ä»å‘½åä¸Šèƒ½çœ‹å‡ºæ¥, è¿™ä¸ªæ•°æ®ç»“æ„é™¤äº†èƒ½å­˜å‚¨äºŒè¿›åˆ¶æ•°æ®, æ˜¾ç„¶æ˜¯ç”¨äºè®¾è®¡ä½œä¸ºå­—ç¬¦ä¸²ä½¿ç”¨çš„, æ‰€ä»¥åœ¨bufä¸­, ç”¨æˆ·æ•°æ®åæ€»è·Ÿç€ä¸€ä¸ª\0. å³å›¾ä¸­ &quot;æ•°æ®&quot; + &quot;\0&quot; æ˜¯ä¸ºæ‰€è°“çš„buf</p><p>SDSæœ‰äº”ç§ä¸åŒçš„å¤´éƒ¨. å…¶ä¸­sdshdr5å®é™…å¹¶æœªä½¿ç”¨åˆ°. æ‰€ä»¥å®é™…ä¸Šæœ‰å››ç§ä¸åŒçš„å¤´éƒ¨, åˆ†åˆ«å¦‚ä¸‹:</p><figure><img src="/assets/668722-20180910183940043-66166526-60c4131a.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>lenåˆ†åˆ«ä»¥uint8, uint16, uint32, uint64è¡¨ç¤ºç”¨æˆ·æ•°æ®çš„é•¿åº¦(ä¸åŒ…æ‹¬æœ«å°¾çš„\0)</li><li>allocåˆ†åˆ«ä»¥uint8, uint16, uint32, uint64è¡¨ç¤ºæ•´ä¸ªSDS, é™¤è¿‡å¤´éƒ¨ä¸æœ«å°¾çš„\0, å‰©ä½™çš„å­—èŠ‚æ•°.</li><li>flagå§‹ç»ˆä¸ºä¸€å­—èŠ‚, ä»¥ä½ä¸‰ä½æ ‡ç¤ºç€å¤´éƒ¨çš„ç±»å‹, é«˜5ä½æœªä½¿ç”¨.</li></ul><p>å½“åœ¨ç¨‹åºä¸­æŒæœ‰ä¸€ä¸ªSDSå®ä¾‹æ—¶, ç›´æ¥æŒæœ‰çš„æ˜¯æ•°æ®åŒºçš„å¤´æŒ‡é’ˆ, è¿™æ ·åšçš„ç”¨æ„æ˜¯: é€šè¿‡è¿™ä¸ªæŒ‡é’ˆ, å‘å‰åä¸€ä¸ªå­—èŠ‚, å°±èƒ½å–åˆ°flag, é€šè¿‡åˆ¤æ–­flagä½ä¸‰ä½çš„å€¼, èƒ½è¿…é€Ÿåˆ¤æ–­: å¤´éƒ¨çš„ç±»å‹, å·²ç”¨å­—èŠ‚æ•°, æ€»å­—èŠ‚æ•°, å‰©ä½™å­—èŠ‚æ•°. è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆsdsç±»å‹å³æ˜¯char *æŒ‡é’ˆç±»å‹åˆ«åçš„åŸå› .</p><p>åˆ›å»ºä¸€ä¸ªSDSå®ä¾‹æœ‰ä¸‰ä¸ªæ¥å£, åˆ†åˆ«æ˜¯:</p><div class="language-cgo line-numbers-mode" data-ext="cgo"><pre class="language-cgo"><code>// åˆ›å»ºä¸€ä¸ªä¸å«æ•°æ®çš„sds: 
//  å¤´éƒ¨    3å­—èŠ‚ sdshdr8
//  æ•°æ®åŒº  0å­—èŠ‚
//  æœ«å°¾    \0 å ä¸€å­—èŠ‚
sds sdsempty(void);
// å¸¦æ•°æ®åˆ›å»ºä¸€ä¸ªsds:
//  å¤´éƒ¨    æŒ‰initlençš„å€¼, é€‰æ‹©æœ€å°çš„å¤´éƒ¨ç±»å‹
//  æ•°æ®åŒº  ä»å…¥å‚æŒ‡é’ˆinitå¤„å¼€å§‹, æ‹·è´initlenä¸ªå­—èŠ‚
//  æœ«å°¾    \0 å ä¸€å­—èŠ‚
sds sdsnewlen(const void *init, size_t initlen);
// å¸¦æ•°æ®åˆ›å»ºä¸€ä¸ªsds:
//  å¤´éƒ¨    æŒ‰strlen(init)çš„å€¼, é€‰æ‹©æœ€å°çš„å¤´éƒ¨ç±»å‹
//  æ•°æ®åŒº  å…¥å‚æŒ‡å‘çš„å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰å­—ç¬¦, ä¸åŒ…æ‹¬æœ«å°¾ \0
//  æœ«å°¾    \0 å ä¸€å­—èŠ‚
sds sdsnew(const char *init);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ‰€æœ‰åˆ›å»ºsdså®ä¾‹çš„æ¥å£, éƒ½ä¸ä¼šé¢å¤–åˆ†é…é¢„ç•™å†…å­˜ç©ºé—´</li><li><code>sdsnewlen</code>ç”¨äºå¸¦äºŒè¿›åˆ¶æ•°æ®åˆ›å»ºsdså®ä¾‹, sdsnewç”¨äºå¸¦å­—ç¬¦ä¸²åˆ›å»ºsdså®ä¾‹. æ¥å£è¿”å›çš„sdså¯ä»¥ç›´æ¥ä¼ å…¥libcä¸­çš„å­—ç¬¦ä¸²è¾“å‡ºå‡½æ•°ä¸­è¿›è¡Œæ“ä½œ, ç”±äºæ— è®ºå…¶ä¸­å­˜å‚¨çš„æ˜¯ç”¨æˆ·çš„äºŒè¿›åˆ¶æ•°æ®, è¿˜æ˜¯å­—ç¬¦ä¸², å…¶æœ«å°¾éƒ½å¸¦ä¸€ä¸ª\0, æ‰€ä»¥è‡³å°‘è°ƒç”¨libcä¸­çš„å­—ç¬¦ä¸²è¾“å‡ºå‡½æ•°æ˜¯å®‰å…¨çš„.</li></ul><p>åœ¨å¯¹SDSä¸­çš„æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶, è‹¥å‰©ä½™ç©ºé—´ä¸è¶³, ä¼šè°ƒç”¨sdsMakeRoomForå‡½æ•°ç”¨äºæ‰©å®¹ç©ºé—´, è¿™æ˜¯ä¸€ä¸ªå¾ˆä½çº§çš„API, é€šå¸¸æƒ…å†µä¸‹ä¸åº”å½“ç”±SDSçš„ä½¿ç”¨è€…ç›´æ¥è°ƒç”¨. å…¶å®ç°ä¸­æ ¸å¿ƒçš„å‡ è¡Œå¦‚ä¸‹:</p><div class="language-cgo line-numbers-mode" data-ext="cgo"><pre class="language-cgo"><code>sds sdsMakeRoomFor(sds s, size_t addlen) {
    ...
    /* Return ASAP if there is enough space left. */
    if (avail &gt;= addlen) return s;

    len = sdslen(s);
    sh = (char*)s-sdsHdrSize(oldtype);
    newlen = (len+addlen);
    if (newlen &lt; SDS_MAX_PREALLOC)
        newlen *= 2;
    else
        newlen += SDS_MAX_PREALLOC;
    ...
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°, åœ¨æ‰©å……ç©ºé—´æ—¶</p><ul><li>å…ˆä¿è¯è‡³å°‘æœ‰addlenå¯ç”¨</li><li>ç„¶åå†è¿›ä¸€æ­¥æ‰©å……, åœ¨æ€»ä½“å ç”¨ç©ºé—´ä¸è¶…è¿‡é˜ˆå€¼<code>SDS_MAC_PREALLOC</code>æ—¶, ç”³è¯·ç©ºé—´å†ç¿»ä¸€å€. è‹¥æ€»ä½“ç©ºé—´å·²ç»è¶…è¿‡äº†é˜ˆå€¼, åˆ™æ­¥è¿›å¢é•¿<code>SDS_MAC_PREALLOC</code>. è¿™ä¸ªé˜ˆå€¼çš„é»˜è®¤å€¼ä¸º <code>1024 * 1024</code></li></ul><p>SDSä¹Ÿæä¾›äº†æ¥å£ç”¨äºç§»é™¤æ‰€æœ‰æœªä½¿ç”¨çš„å†…å­˜ç©ºé—´. <code>sdsRemoveFreeSpace</code>, è¯¥æ¥å£æ²¡æœ‰é—´æ¥çš„è¢«ä»»ä½•SDSå…¶å®ƒæ¥å£è°ƒç”¨, å³é»˜è®¤æƒ…å†µä¸‹, SDSä¸ä¼šè‡ªåŠ¨å›æ”¶é¢„ç•™ç©ºé—´. åœ¨SDSçš„ä½¿ç”¨è€…éœ€è¦èŠ‚çœå†…å­˜æ—¶, ç”±ä½¿ç”¨è€…è‡ªè¡Œè°ƒç”¨:</p><div class="language-cgo line-numbers-mode" data-ext="cgo"><pre class="language-cgo"><code>sds sdsRemoveFreeSpace(sds s);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ€»ç»“:</p><ul><li>SDSé™¤äº†æ˜¯æŸäº›Value Typeçš„åº•å±‚å®ç°, ä¹Ÿè¢«å¤§é‡ä½¿ç”¨åœ¨Rediså†…éƒ¨, ç”¨äºæ›¿ä»£C-Styleå­—ç¬¦ä¸². æ‰€ä»¥é»˜è®¤çš„åˆ›å»ºSDSå®ä¾‹æ¥å£, ä¸åˆ†é…é¢å¤–çš„é¢„ç•™ç©ºé—´. å› ä¸ºå¤šæ•°å­—ç¬¦ä¸²åœ¨ç¨‹åºè¿è¡ŒæœŸé—´æ˜¯ä¸å˜çš„. è€Œå¯¹äºå˜æ›´æ•°æ®åŒºçš„API, å…¶å†…éƒ¨åˆ™æ˜¯è°ƒç”¨äº† sdsMakeRoomFor, æ¯ä¸€æ¬¡æ‰©å……ç©ºé—´, éƒ½ä¼šé¢„ç•™å¤§é‡çš„ç©ºé—´. è¿™æ ·åšçš„è€ƒé‡æ˜¯: å¦‚æœä¸€ä¸ªSDSå®ä¾‹ä¸­çš„æ•°æ®è¢«å˜æ›´äº†, é‚£ä¹ˆå¾ˆæœ‰å¯èƒ½ä¼šåœ¨åç»­å‘ç”Ÿå¤šæ¬¡å˜æ›´.</li><li>SDSçš„APIå†…éƒ¨ä¸è´Ÿè´£æ¸…é™¤æœªä½¿ç”¨çš„é—²ç½®å†…å­˜ç©ºé—´, å› ä¸ºå†…éƒ¨APIæ— æ³•åˆ¤æ–­è¿™æ ·åšçš„åˆé€‚æ—¶æœº. å³ä¾¿æ˜¯åœ¨æ“ä½œæ•°æ®åŒºçš„æ—¶å€™å¯¼è‡´æ•°æ®åŒºå ç”¨å†…å­˜å‡å°‘æ—¶, å†…éƒ¨APIä¹Ÿä¸ä¼šæ¸…é™¤é—²ç½®å†…åœ¨ç©ºé—´. æ¸…é™¤é—²ç½®å†…å­˜ç©ºé—´è´£ä»»åº”å½“ç”±SDSçš„ä½¿ç”¨è€…è‡ªè¡Œæ‹…å½“.</li><li>ç”¨SDSæ›¿ä»£C-Styleå­—ç¬¦ä¸²æ—¶, ç”±äºå…¶å¤´éƒ¨é¢å¤–å­˜å‚¨äº†æ•°æ®åŒºçš„é•¿åº¦ä¿¡æ¯, æ‰€ä»¥å­—ç¬¦ä¸²çš„æ±‚é•¿æ“ä½œæ—¶é—´å¤æ‚åº¦ä¸ºO(1)</li></ul><h3 id="_2-2-list" tabindex="-1"><a class="header-anchor" href="#_2-2-list" aria-hidden="true">#</a> 2.2 list</h3><p>è¿™æ˜¯æ™®é€šçš„é“¾è¡¨å®ç°, é“¾è¡¨ç»“ç‚¹ä¸ç›´æ¥æŒæœ‰æ•°æ®, è€Œæ˜¯é€šè¿‡void *æŒ‡é’ˆæ¥é—´æ¥çš„æŒ‡å‘æ•°æ®. å…¶å®ç°ä½äº src/adlist.hä¸src/adlist.cä¸­, å…³é”®å®šä¹‰å¦‚ä¸‹:</p><div class="language-cgo line-numbers-mode" data-ext="cgo"><pre class="language-cgo"><code>typedef struct listNode {
    struct listNode *prev;
    struct listNode *next;
    void *value;
} listNode;

typedef struct listIter {
    listNode *next;
    int direction;
} listIter;

typedef struct list {
    listNode *head;
    listNode *tail;
    void *(*dup)(void *ptr);
    void (*free)(void *ptr);
    int (*match)(void *ptr, void *key);
    unsigned long len;
} list;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤º:</p><figure><img src="/assets/668722-20180910184001095-98860783-01513d23.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>è¿™æ˜¯ä¸€ä¸ªå¹³å¹³æ— å¥‡çš„é“¾è¡¨çš„å®ç°. liståœ¨Redisé™¤äº†ä½œä¸ºä¸€äº›Value Typeçš„åº•å±‚å®ç°å¤–, è¿˜å¹¿æ³›ç”¨äºRedisçš„å…¶å®ƒåŠŸèƒ½å®ç°ä¸­, ä½œä¸ºä¸€ç§æ•°æ®ç»“æ„å·¥å…·ä½¿ç”¨. åœ¨listçš„å®ç°ä¸­, é™¤äº†åŸºæœ¬çš„é“¾è¡¨å®šä¹‰å¤–, è¿˜é¢å¤–å¢åŠ äº†:</p><ul><li>è¿­ä»£å™¨<code>listIter</code>çš„å®šä¹‰, ä¸ç›¸å…³æ¥å£çš„å®ç°.</li><li>ç”±äºlistä¸­çš„é“¾è¡¨ç»“ç‚¹æœ¬èº«å¹¶ä¸ç›´æ¥æŒæœ‰æ•°æ®, è€Œæ˜¯é€šè¿‡valueå­—æ®µ, ä»¥void *æŒ‡é’ˆçš„å½¢å¼é—´æ¥æŒæœ‰, æ‰€ä»¥æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸå¹¶ä¸å®Œå…¨ä¸é“¾è¡¨åŠå…¶ç»“ç‚¹ä¸€è‡´. è¿™ç»™äº†listçš„ä½¿ç”¨è€…ç›¸å½“å¤§çš„çµæ´»æ€§. æ¯”å¦‚å¯ä»¥å¤šä¸ªç»“ç‚¹æŒæœ‰åŒä¸€ä»½æ•°æ®çš„åœ°å€. ä½†ä¸æ­¤åŒæ—¶, åœ¨å¯¹é“¾è¡¨è¿›è¡Œé”€æ¯, ç»“ç‚¹å¤åˆ¶ä»¥åŠæŸ¥æ‰¾åŒ¹é…æ—¶, å°±éœ€è¦listçš„ä½¿ç”¨è€…å°†ç›¸å…³çš„å‡½æ•°æŒ‡é’ˆèµ‹å€¼äºlist.dup, list.free, list.matchå­—æ®µ.</li></ul><h3 id="_2-3-dict" tabindex="-1"><a class="header-anchor" href="#_2-3-dict" aria-hidden="true">#</a> 2.3 dict</h3><p>dictæ˜¯Redisåº•å±‚æ•°æ®ç»“æ„ä¸­å®ç°æœ€ä¸ºå¤æ‚çš„ä¸€ä¸ªæ•°æ®ç»“æ„, å…¶åŠŸèƒ½ç±»ä¼¼äºC++æ ‡å‡†åº“ä¸­çš„std::unordered_map, å…¶å®ç°ä½äº src/dict.h ä¸ src/dict.cä¸­, å…¶å…³é”®å®šä¹‰å¦‚ä¸‹:</p><div class="language-cgo line-numbers-mode" data-ext="cgo"><pre class="language-cgo"><code>typedef struct dictEntry {
    void *key;
    union {
        void *val;
        uint64_t u64;
        int64_t s64;
        double d;
    } v;
    struct dictEntry *next;
} dictEntry;

typedef struct dictType {
    uint64_t (*hashFunction)(const void *key);
    void *(*keyDup)(void *privdata, const void *key);
    void *(*valDup)(void *privdata, const void *obj);
    int (*keyCompare)(void *privdata, const void *key1, const void *key2);
    void (*keyDestructor)(void *privdata, void *key);
    void (*valDestructor)(void *privdata, void *obj);
} dictType;

/* This is our hash table structure. Every dictionary has two of this as we
 * implement incremental rehashing, for the old to the new table. */
typedef struct dictht {
    dictEntry **table;
    unsigned long size;
    unsigned long sizemask;
    unsigned long used;
} dictht;

typedef struct dict {
    dictType *type;
    void *privdata;
    dictht ht[2];
    long rehashidx; /* rehashing not in progress if rehashidx == -1 */
    unsigned long iterators; /* number of iterators currently running */
} dict;

/* If safe is set to 1 this is a safe iterator, that means, you can call
 * dictAdd, dictFind, and other functions against the dictionary even while
 * iterating. Otherwise it is a non safe iterator, and only dictNext()
 * should be called while iterating. */
typedef struct dictIterator {
    dict *d;
    long index;
    int table, safe;
    dictEntry *entry, *nextEntry;
    /* unsafe iterator fingerprint for misuse detection. */
    long long fingerprint;
} dictIterator;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹æ‰€ç¤º:</p><figure><img src="/assets/668722-20180910184019522-1324296109-326bbf8e.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li><p>dictä¸­å­˜å‚¨çš„é”®å€¼å¯¹, æ˜¯é€šè¿‡dictEntryè¿™ä¸ªç»“æ„é—´æ¥æŒæœ‰çš„, ké€šè¿‡æŒ‡é’ˆé—´æ¥æŒæœ‰é”®, vé€šè¿‡æŒ‡é’ˆé—´æ¥æŒæœ‰å€¼. æ³¨æ„, è‹¥å€¼æ˜¯æ•´æ•°å€¼çš„è¯, æ˜¯ç›´æ¥å­˜å‚¨åœ¨vå­—æ®µä¸­çš„, è€Œä¸æ˜¯é—´æ¥æŒæœ‰. åŒæ—¶nextæŒ‡é’ˆç”¨äºæŒ‡å‘, åœ¨bucketç´¢å¼•å€¼å†²çªæ—¶, ä»¥é“¾å¼æ–¹å¼è§£å†³å†²çª, æŒ‡å‘åŒç´¢å¼•çš„ä¸‹ä¸€ä¸ªdictEntryç»“æ„.</p></li><li><p>ä¼ ç»Ÿçš„å“ˆå¸Œè¡¨å®ç°, æ˜¯ä¸€å—è¿ç»­ç©ºé—´çš„é¡ºåºè¡¨, è¡¨ä¸­å…ƒç´ å³æ˜¯ç»“ç‚¹. åœ¨dictht.tableä¸­, ç»“ç‚¹æœ¬èº«æ˜¯æ•£å¸ƒåœ¨å†…å­˜ä¸­çš„, é¡ºåºè¡¨ä¸­å­˜å‚¨çš„æ˜¯dictEntryçš„æŒ‡é’ˆ</p></li><li><p>å“ˆå¸Œè¡¨å³æ˜¯dicthtç»“æ„, å…¶é€šè¿‡tableå­—æ®µé—´æ¥çš„æŒæœ‰é¡ºåºè¡¨å½¢å¼çš„bucket, bucketçš„å®¹é‡å­˜å‚¨åœ¨sizeå­—æ®µä¸­, ä¸ºäº†åŠ é€Ÿå°†æ•£åˆ—å€¼è½¬åŒ–ä¸ºbucketä¸­çš„æ•°ç»„ç´¢å¼•, å¼•å…¥äº†sizemaskå­—æ®µ, è®¡ç®—æŒ‡å®šé”®åœ¨å“ˆå¸Œè¡¨ä¸­çš„ç´¢å¼•æ—¶, æ‰§è¡Œçš„æ“ä½œç±»ä¼¼äºdict-&gt;type-&gt;hashFunction(é”®) &amp; dict-&gt;ht[x].sizemask. ä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºæ¥, bucketçš„å®¹é‡é€‚å®œäºä¸º2çš„å¹‚æ¬¡, è¿™æ ·è®¡ç®—å‡ºçš„ç´¢å¼•å€¼èƒ½è¦†ç›–åˆ°æ‰€æœ‰bucketç´¢å¼•ä½.</p></li><li><p>dictå³ä¸ºå­—å…¸. å…¶ä¸­typeå­—æ®µä¸­å­˜å‚¨çš„æ˜¯æœ¬å­—å…¸ä½¿ç”¨åˆ°çš„å„ç§å‡½æ•°æŒ‡é’ˆ, åŒ…æ‹¬æ•£åˆ—å‡½æ•°, é”®ä¸å€¼çš„å¤åˆ¶å‡½æ•°, é‡Šæ”¾å‡½æ•°, ä»¥åŠé”®çš„æ¯”è¾ƒå‡½æ•°. privdataæ˜¯ç”¨äºå­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®. è¿™æ ·, å­—å…¸çš„ä½¿ç”¨è€…å¯ä»¥æœ€å¤§åŒ–çš„è‡ªå®šä¹‰å­—å…¸çš„å®ç°, é€šè¿‡è‡ªå®šä¹‰å„ç§å‡½æ•°å®ç°, ä»¥åŠå¯ä»¥é™„å¸¦ç§æœ‰æ•°æ®, ä¿è¯äº†å­—å…¸æœ‰å¾ˆå¤§çš„è°ƒä¼˜ç©ºé—´.</p></li><li><p>å­—å…¸ä¸ºäº†æ”¯æŒå¹³æ»‘æ‰©å®¹, å®šä¹‰äº†ht[2]è¿™ä¸ªæ•°ç»„å­—æ®µ. å…¶ç”¨æ„æ˜¯è¿™æ ·çš„:</p><ol><li>ä¸€èˆ¬æƒ…å†µä¸‹, å­—å…¸dictä»…æŒæœ‰ä¸€ä¸ªå“ˆå¸Œè¡¨dicthtçš„å®ä¾‹, å³æ•´ä¸ªå­—å…¸ç”±ä¸€ä¸ªbucketå®ç°.</li><li>éšç€æ’å…¥æ“ä½œ, bucketä¸­å‡ºç°å†²çªçš„æ¦‚ç‡ä¼šè¶Šæ¥è¶Šå¤§, å½“å­—å…¸ä¸­å­˜å‚¨çš„ç»“ç‚¹æ•°ç›®, ä¸bucketæ•°ç»„é•¿åº¦çš„æ¯”å€¼è¾¾åˆ°ä¸€ä¸ªé˜ˆå€¼(1:1)æ—¶, å­—å…¸ä¸ºäº†ç¼“è§£æ€§èƒ½ä¸‹é™, å°±éœ€è¦æ‰©å®¹</li><li>æ‰©å®¹çš„æ“ä½œæ˜¯å¹³æ»‘çš„, å³åœ¨æ‰©å®¹æ—¶, å­—å…¸ä¼šæŒæœ‰ä¸¤ä¸ªdicthtçš„å®ä¾‹, ht[0]æŒ‡å‘æ—§å“ˆå¸Œè¡¨, ht[1]æŒ‡å‘æ‰©å®¹åçš„æ–°å“ˆå¸Œè¡¨. å¹³æ»‘æ‰©å®¹çš„é‡ç‚¹åœ¨äºä¸¤ä¸ªç­–ç•¥:</li><li>åç»­æ¯ä¸€æ¬¡çš„æ’å…¥, æ›¿æ¢, æŸ¥æ‰¾æ“ä½œ, éƒ½æ’å…¥åˆ°ht[1]æŒ‡å‘çš„å“ˆå¸Œè¡¨ä¸­</li><li>æ¯ä¸€æ¬¡æ’å…¥, æ›¿æ¢, æŸ¥æ‰¾æ“ä½œæ‰§è¡Œæ—¶, ä¼šå°†æ—§è¡¨ht[0]ä¸­çš„ä¸€ä¸ªbucketç´¢å¼•ä½æŒæœ‰çš„ç»“ç‚¹é“¾è¡¨, è¿ç§»åˆ°ht[1]ä¸­å». è¿ç§»çš„è¿›åº¦ä¿å­˜åœ¨rehashidxè¿™ä¸ªå­—æ®µä¸­.åœ¨æ—§è¡¨ä¸­ç”±äºå†²çªè€Œè¢«é“¾æ¥åœ¨åŒä¸€ç´¢å¼•ä½ä¸Šçš„ç»“ç‚¹, è¿ç§»åˆ°æ–°è¡¨å, å¯èƒ½ä¼šæ•£å¸ƒåœ¨å¤šä¸ªæ–°è¡¨ç´¢å¼•ä¸­å».</li><li>å½“è¿ç§»å®Œæˆå, ht[0]æŒ‡å‘çš„æ—§è¡¨ä¼šè¢«é‡Šæ”¾, ä¹‹åä¼šå°†æ–°è¡¨çš„æŒæœ‰æƒè½¬äº¤ç»™ht[0], å†é‡ç½®ht[1]æŒ‡å‘NULL</li></ol></li><li><p>è¿™ç§å¹³æ»‘æ‰©å®¹çš„ä¼˜ç‚¹æœ‰ä¸¤ä¸ª:</p><ol><li>å¹³æ»‘æ‰©å®¹è¿‡ç¨‹ä¸­, æ‰€æœ‰ç»“ç‚¹çš„å®é™…æ•°æ®, å³dict-&gt;ht[0]-&gt;table[rehashindex]-&gt;kä¸dict-&gt;ht[0]-&gt;table[rehashindex]-&gt;våˆ†åˆ«æŒ‡å‘çš„å®é™…æ•°æ®, å†…å­˜åœ°å€éƒ½ä¸ä¼šå˜åŒ–. æ²¡æœ‰å‘ç”Ÿé”®æ•°æ®ä¸å€¼æ•°æ®çš„æ‹·è´æˆ–ç§»åŠ¨, æ‰©å®¹æ•´ä¸ªè¿‡ç¨‹ä»…æ˜¯å„ç§æŒ‡é’ˆçš„æ“ä½œ. é€Ÿåº¦éå¸¸å¿«</li><li>æ‰©å®¹æ“ä½œæ˜¯æ­¥è¿›å¼çš„, è¿™ä¿è¯ä»»ä½•ä¸€æ¬¡æ’å…¥æ“ä½œéƒ½æ˜¯é¡ºç•…çš„, dictçš„ä½¿ç”¨è€…æ˜¯æ— æ„ŸçŸ¥çš„. è‹¥æ‰©å®¹æ˜¯ä¸€æ¬¡æ€§çš„, å½“æ–°æ—§bucketå®¹é‡ç‰¹åˆ«å¤§æ—¶, è¿ç§»æ‰€æœ‰ç»“ç‚¹å¿…ç„¶ä¼šå¯¼è‡´è€—æ—¶é™¡å¢.</li></ol></li></ul><p>é™¤äº†å­—å…¸æœ¬èº«çš„å®ç°å¤–, å…¶ä¸­è¿˜é¡ºå¸¦å®ç°äº†ä¸€ä¸ªè¿­ä»£å™¨, è¿™ä¸ªè¿­ä»£å™¨ä¸­æœ‰å­—æ®µsafeä»¥æ ‡ç¤ºè¯¥è¿­ä»£å™¨æ˜¯&quot;å®‰å…¨è¿­ä»£å™¨&quot;è¿˜æ˜¯&quot;éå®‰å…¨è¿­ä»£å™¨&quot;, æ‰€è°“çš„å®‰å…¨ä¸å¦, æŒ‡æ˜¯çš„è¿™ç§åœºæ™¯:<br> è®¾æƒ³åœ¨è¿è¡Œè¿­ä»£å™¨çš„è¿‡ç¨‹ä¸­, å­—å…¸æ­£å¤„äºå¹³æ»‘æ‰©å®¹çš„è¿‡ç¨‹ä¸­. åœ¨å¹³æ»‘æ‰©å®¹çš„è¿‡ç¨‹ä¸­æ—¶, æ—§è¡¨ä¸€ä¸ªç´¢å¼•ä½ä¸Šçš„, ç”±å†²çªè€Œé“¾èµ·æ¥çš„å¤šä¸ªç»“ç‚¹, è¿ç§»åˆ°æ–°è¡¨å, å¯èƒ½ä¼šæ•£å¸ƒåˆ°æ–°è¡¨çš„å¤šä¸ªç´¢å¼•ä½ä¸Š. ä¸”æ–°çš„ç´¢å¼•ä½çš„å€¼å¯èƒ½æ¯”æ—§çš„ç´¢å¼•ä½è¦ä½.</p><p>éå†æ“ä½œçš„é‡ç‚¹æ˜¯, ä¿è¯åœ¨è¿­ä»£å™¨éå†æ“ä½œå¼€å§‹æ—¶, å­—å…¸ä¸­æŒæœ‰çš„æ‰€æœ‰ç»“ç‚¹, éƒ½ä¼šè¢«éå†åˆ°. è€Œè‹¥åœ¨éå†è¿‡ç¨‹ä¸­, ä¸€ä¸ªæœªéå†çš„ç»“ç‚¹, ä»æ—§è¡¨è¿ç§»åˆ°æ–°è¡¨å, ç´¢å¼•å€¼å‡å°äº†, é‚£ä¹ˆå°±å¯èƒ½ä¼šå¯¼è‡´è¿™ä¸ªç»“ç‚¹åœ¨éå†è¿‡ç¨‹ä¸­è¢«é—æ¼.</p><p>æ‰€ä»¥, æ‰€è°“çš„&quot;å®‰å…¨&quot;è¿­ä»£å™¨, å…¶åœ¨å†…éƒ¨å®ç°æ—¶: åœ¨è¿­ä»£è¿‡ç¨‹ä¸­, è‹¥å­—å…¸æ­£å¤„äºå¹³æ»‘æ‰©å®¹è¿‡ç¨‹, åˆ™æš‚åœç»“ç‚¹è¿ç§», ç›´è‡³è¿­ä»£å™¨è¿è¡Œç»“æŸ. è¿™æ ·è™½ç„¶ä¸èƒ½ä¿è¯åœ¨è¿­ä»£è¿‡ç¨‹ä¸­æ’å…¥çš„ç»“ç‚¹ä¼šè¢«éå†åˆ°, ä½†è‡³å°‘ä¿è¯åœ¨è¿­ä»£èµ·å§‹æ—¶, å­—å…¸ä¸­æŒæœ‰çš„æ‰€æœ‰ç»“ç‚¹éƒ½ä¼šè¢«éå†åˆ°.</p><p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆdictç»“æ„ä¸­æœ‰ä¸€ä¸ªiteratorså­—æ®µçš„åŸå› : è¯¥å­—æ®µè®°å½•äº†è¿è¡Œäºè¯¥å­—å…¸ä¸Šçš„å®‰å…¨è¿­ä»£å™¨çš„æ•°ç›®. è‹¥è¯¥æ•°ç›®ä¸ä¸º0, å­—å…¸æ˜¯ä¸ä¼šç»§ç»­è¿›è¡Œç»“ç‚¹è¿ç§»å¹³æ»‘æ‰©å®¹çš„.</p><p>ä¸‹é¢æ˜¯å­—å…¸çš„æ‰©å®¹æ“ä½œä¸­çš„æ ¸å¿ƒä»£ç , æˆ‘ä»¬ä»¥æ’å…¥æ“ä½œå¼•èµ·çš„æ‰©å®¹ä¸ºä¾‹:</p><p><strong>å…ˆæ˜¯æ’å…¥æ“ä½œçš„å¤–éƒ¨é€»è¾‘:</strong></p><ol><li>å¦‚æœæ’å…¥æ—¶, å­—å…¸æ­£å¤„äºå¹³æ»‘æ‰©å®¹è¿‡ç¨‹ä¸­, é‚£ä¹ˆæ— è®ºæœ¬æ¬¡æ’å…¥æ˜¯å¦æˆåŠŸ, å…ˆè¿ç§»ä¸€ä¸ªbucketç´¢å¼•ä¸­çš„ç»“ç‚¹è‡³æ–°è¡¨</li><li>åœ¨è®¡ç®—æ–°æ’å…¥ç»“ç‚¹é”®çš„bucketç´¢å¼•å€¼æ—¶, å†…éƒ¨ä¼šæ¢æµ‹å“ˆå¸Œè¡¨æ˜¯å¦éœ€è¦æ‰©å®¹(è‹¥å½“å‰ä¸åœ¨å¹³æ»‘æ‰©å®¹è¿‡ç¨‹ä¸­)</li></ol><div class="language-cgo line-numbers-mode" data-ext="cgo"><pre class="language-cgo"><code>int dictAdd(dict *d, void *key, void *val)
{
    dictEntry *entry = dictAddRaw(d,key,NULL);          // è°ƒç”¨dictAddRaw

    if (!entry) return DICT_ERR;
    dictSetVal(d, entry, val);
    return DICT_OK;
}

dictEntry *dictAddRaw(dict *d, void *key, dictEntry **existing)
{
    long index;
    dictEntry *entry;
    dictht *ht;

    if (dictIsRehashing(d)) _dictRehashStep(d); // è‹¥åœ¨å¹³æ»‘æ‰©å®¹è¿‡ç¨‹ä¸­, å…ˆæ­¥è¿›è¿ç§»ä¸€ä¸ªbucketç´¢å¼•

    /* Get the index of the new element, or -1 if
     * the element already exists. */

    // åœ¨è®¡ç®—é”®åœ¨bucketä¸­çš„ç´¢å¼•å€¼æ—¶, å†…éƒ¨ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹
    if ((index = _dictKeyIndex(d, key, dictHashKey(d,key), existing)) == -1)
        return NULL;

    /* Allocate the memory and store the new entry.
     * Insert the element in top, with the assumption that in a database
     * system it is more likely that recently added entries are accessed
     * more frequently. */
    ht = dictIsRehashing(d) ? &amp;d-&gt;ht[1] : &amp;d-&gt;ht[0];
    entry = zmalloc(sizeof(*entry));
    entry-&gt;next = ht-&gt;table[index];
    ht-&gt;table[index] = entry;
    ht-&gt;used++;

    /* Set the hash entry fields. */
    dictSetKey(d, entry, key);
    return entry;
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æ˜¯è®¡ç®—bucketç´¢å¼•å€¼çš„å‡½æ•°, å†…éƒ¨ä¼šæ¢æµ‹è¯¥å“ˆå¸Œè¡¨æ˜¯å¦éœ€è¦æ‰©å®¹, å¦‚æœéœ€è¦æ‰©å®¹(ç»“ç‚¹æ•°ç›®ä¸bucketæ•°ç»„é•¿åº¦æ¯”ä¾‹è¾¾åˆ°1:1), å°±ä½¿å­—å…¸è¿›å…¥å¹³æ»‘æ‰©å®¹è¿‡ç¨‹:</p><div class="language-cgo line-numbers-mode" data-ext="cgo"><pre class="language-cgo"><code>static long _dictKeyIndex(dict *d, const void *key, uint64_t hash, dictEntry **existing)
{
    unsigned long idx, table;
    dictEntry *he;
    if (existing) *existing = NULL;

    /* Expand the hash table if needed */
    if (_dictExpandIfNeeded(d) == DICT_ERR) // æ¢æµ‹æ˜¯å¦éœ€è¦æ‰©å®¹, å¦‚æœéœ€è¦, åˆ™å¼€å§‹æ‰©å®¹
        return -1;
    for (table = 0; table &lt;= 1; table++) {
        idx = hash &amp; d-&gt;ht[table].sizemask;
        /* Search if this slot does not already contain the given key */
        he = d-&gt;ht[table].table[idx];
        while(he) {
            if (key==he-&gt;key || dictCompareKeys(d, key, he-&gt;key)) {
                if (existing) *existing = he;
                return -1;
            }
            he = he-&gt;next;
        }
        if (!dictIsRehashing(d)) break;
    }
    return idx;
}

/* Expand the hash table if needed */
static int _dictExpandIfNeeded(dict *d)
{
    /* Incremental rehashing already in progress. Return. */
    if (dictIsRehashing(d)) return DICT_OK; // å¦‚æœæ­£åœ¨æ‰©å®¹è¿‡ç¨‹ä¸­, åˆ™ä»€ä¹ˆä¹Ÿä¸åš

    /* If the hash table is empty expand it to the initial size. */
    // è‹¥å­—å…¸ä¸­æœ¬æ— å…ƒç´ , åˆ™åˆå§‹åŒ–å­—å…¸, åˆå§‹åŒ–æ—¶çš„bucketæ•°ç»„é•¿åº¦ä¸º4
    if (d-&gt;ht[0].size == 0) return dictExpand(d, DICT_HT_INITIAL_SIZE);

    /* If we reached the 1:1 ratio, and we are allowed to resize the hash
     * table (global setting) or we should avoid it but the ratio between
     * elements/buckets is over the &quot;safe&quot; threshold, we resize doubling
     * the number of buckets. */
    // è‹¥å­—å…¸ä¸­å…ƒç´ çš„ä¸ªæ•°ä¸bucketæ•°ç»„é•¿åº¦æ¯”å€¼å¤§äº1:1æ—¶, åˆ™è°ƒç”¨dictExpandè¿›å…¥å¹³æ»‘æ‰©å®¹çŠ¶æ€
    if (d-&gt;ht[0].used &gt;= d-&gt;ht[0].size &amp;&amp;
        (dict_can_resize ||
         d-&gt;ht[0].used/d-&gt;ht[0].size &gt; dict_force_resize_ratio))
    {
        return dictExpand(d, d-&gt;ht[0].used*2);
    }
    return DICT_OK;
}

int dictExpand(dict *d, unsigned long size)
{
    dictht n; /* the new hash table */  // æ–°å»ºä¸€ä¸ªdicthtç»“æ„
    unsigned long realsize = _dictNextPower(size);  

    /* the size is invalid if it is smaller than the number of
     * elements already inside the hash table */
    if (dictIsRehashing(d) || d-&gt;ht[0].used &gt; size)
        return DICT_ERR;

    /* Rehashing to the same table size is not useful. */
    if (realsize == d-&gt;ht[0].size) return DICT_ERR;

    /* Allocate the new hash table and initialize all pointers to NULL */
    n.size = realsize;
    n.sizemask = realsize-1;
    n.table = zcalloc(realsize*sizeof(dictEntry*));// åˆå§‹åŒ–dicthtä¸‹çš„table, å³bucketæ•°ç»„
    n.used = 0;

    /* Is this the first initialization? If so it&#39;s not really a rehashing
     * we just set the first hash table so that it can accept keys. */
    // è‹¥æ˜¯æ–°å­—å…¸åˆå§‹åŒ–, ç›´æ¥æŠŠdicthtç»“æ„æŒ‚åœ¨ht[0]ä¸­
    if (d-&gt;ht[0].table == NULL) {
        d-&gt;ht[0] = n;
        return DICT_OK;
    }

    // å¦åˆ™, æŠŠæ–°dicthtç»“æ„æŒ‚åœ¨ht[1]ä¸­, å¹¶å¼€å¯å¹³æ»‘æ‰©å®¹(ç½®rehashidxä¸º0, å­—å…¸å¤„äºéæ‰©å®¹çŠ¶æ€æ—¶, è¯¥å­—æ®µå€¼ä¸º-1)
    /* Prepare a second hash table for incremental rehashing */
    d-&gt;ht[1] = n;
    d-&gt;rehashidx = 0;
    return DICT_OK;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æ˜¯å¹³æ»‘æ‰©å®¹çš„å®ç°:</p><div class="language-cgo line-numbers-mode" data-ext="cgo"><pre class="language-cgo"><code>static void _dictRehashStep(dict *d) {
    // è‹¥å­—å…¸ä¸Šè¿˜è¿è¡Œç€å®‰å…¨è¿­ä»£å™¨, åˆ™ä¸è¿ç§»ç»“ç‚¹
    // å¦åˆ™æ¯æ¬¡è¿ç§»ä¸€ä¸ªæ—§bucketç´¢å¼•ä¸Šçš„æ‰€æœ‰ç»“ç‚¹
    if (d-&gt;iterators == 0) dictRehash(d,1); 
}

int dictRehash(dict *d, int n) {
    int empty_visits = n*10; /* Max number of empty buckets to visit. */
    if (!dictIsRehashing(d)) return 0;

    while(n-- &amp;&amp; d-&gt;ht[0].used != 0) {
        dictEntry *de, *nextde;

        /* Note that rehashidx can&#39;t overflow as we are sure there are more
         * elements because ht[0].used != 0 */
        assert(d-&gt;ht[0].size &gt; (unsigned long)d-&gt;rehashidx);
        // åœ¨æ—§bucketä¸­, æ‰¾åˆ°ä¸‹ä¸€ä¸ªéç©ºçš„ç´¢å¼•ä½
        while(d-&gt;ht[0].table[d-&gt;rehashidx] == NULL) {
            d-&gt;rehashidx++;
            if (--empty_visits == 0) return 1;
        }
        // å–å‡ºè¯¥ç´¢å¼•ä½ä¸Šçš„ç»“ç‚¹é“¾è¡¨
        de = d-&gt;ht[0].table[d-&gt;rehashidx];
        /* Move all the keys in this bucket from the old to the new hash HT */
        // æŠŠæ‰€æœ‰ç»“ç‚¹è¿ç§»åˆ°æ–°bucketä¸­å»
        while(de) {
            uint64_t h;

            nextde = de-&gt;next;
            /* Get the index in the new hash table */
            h = dictHashKey(d, de-&gt;key) &amp; d-&gt;ht[1].sizemask;
            de-&gt;next = d-&gt;ht[1].table[h];
            d-&gt;ht[1].table[h] = de;
            d-&gt;ht[0].used--;
            d-&gt;ht[1].used++;
            de = nextde;
        }
        d-&gt;ht[0].table[d-&gt;rehashidx] = NULL;
        d-&gt;rehashidx++;
    }

    /* Check if we already rehashed the whole table... */
    // æ£€æŸ¥æ˜¯å¦æ—§è¡¨ä¸­çš„æ‰€æœ‰ç»“ç‚¹éƒ½è¢«è¿ç§»åˆ°äº†æ–°è¡¨
    // å¦‚æœæ˜¯, åˆ™ç½®å…ˆé‡Šæ”¾åŸæ—§bucketæ•°ç»„, å†ç½®ht[1]ä¸ºht[0]
    // æœ€åå†ç½®rehashidx=-1, ä»¥ç¤ºå­—å…¸ä¸å¤„äºå¹³æ»‘æ‰©å®¹çŠ¶æ€
    if (d-&gt;ht[0].used == 0) {
        zfree(d-&gt;ht[0].table);
        d-&gt;ht[0] = d-&gt;ht[1];
        _dictReset(&amp;d-&gt;ht[1]);
        d-&gt;rehashidx = -1;
        return 0;
    }

    /* More to rehash... */
    return 1;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ€»ç»“:</strong></p><p>å­—å…¸çš„å®ç°å¾ˆå¤æ‚, ä¸»è¦æ˜¯å®ç°äº†å¹³æ»‘æ‰©å®¹é€»è¾‘<br> ç”¨æˆ·æ•°æ®å‡æ˜¯ä»¥æŒ‡é’ˆå½¢å¼é—´æ¥ç”±dictEntryç»“æ„æŒæœ‰, æ•…åœ¨å¹³æ»‘æ‰©å®¹è¿‡ç¨‹ä¸­, ä¸æ¶‰åŠç”¨æˆ·æ•°æ®çš„æ‹·è´<br> æœ‰å®‰å…¨è¿­ä»£å™¨å¯ç”¨, å®‰å…¨è¿­ä»£å™¨ä¿è¯, åœ¨è¿­ä»£èµ·å§‹æ—¶, å­—å…¸ä¸­çš„æ‰€æœ‰ç»“ç‚¹, éƒ½ä¼šè¢«è¿­ä»£åˆ°, å³ä½¿åœ¨è¿­ä»£è¿‡ç¨‹ä¸­å¯¹å­—å…¸æœ‰æ’å…¥æ“ä½œ<br> å­—å…¸å†…éƒ¨ä½¿ç”¨çš„é»˜è®¤æ•£åˆ—å‡½æ•°å…¶å®ä¹Ÿéå¸¸æœ‰è®²ç©¶, ä¸è¿‡é™äºç¯‡å¹…, è¿™é‡Œä¸å±•å¼€è®². å¹¶ä¸”å­—å…¸çš„å®ç°ç»™äº†ä½¿ç”¨è€…éå¸¸å¤§çš„çµæ´»æ€§(dictTypeç»“æ„ä¸dict.privdataå­—æ®µ), å¯¹äºä¸€äº›ç‰¹å®šåœºåˆä½¿ç”¨çš„é”®æ•°æ®, ç”¨æˆ·å¯ä»¥è‡ªè¡Œé€‰æ‹©æ›´é«˜æ•ˆæ›´ç‰¹å®šåŒ–çš„æ•£åˆ—å‡½æ•°</p><h3 id="_2-4-zskiplist" tabindex="-1"><a class="header-anchor" href="#_2-4-zskiplist" aria-hidden="true">#</a> 2.4 zskiplist</h3><p>zskiplistæ˜¯Rediså®ç°çš„ä¸€ç§ç‰¹æ®Šçš„è·³è·ƒè¡¨. è·³è·ƒè¡¨æ˜¯ä¸€ç§åŸºäºçº¿æ€§è¡¨å®ç°ç®€å•çš„æœç´¢ç»“æ„, å…¶æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯: å®ç°ç®€å•, æ€§èƒ½èƒ½é€¼è¿‘å„ç§æœç´¢æ ‘ç»“æ„. è¡€ç»Ÿçº¯æ­£çš„è·³è·ƒè¡¨çš„ä»‹ç»åœ¨ç»´åŸºç™¾ç§‘ä¸­å³å¯æŸ¥é˜…. åœ¨Redisä¸­, åœ¨åŸç‰ˆè·³è·ƒè¡¨çš„åŸºç¡€ä¸Š, è¿›è¡Œäº†ä¸€äº›å°æ”¹åŠ¨, å³æ˜¯ç°åœ¨è¦ä»‹ç»çš„zskiplistç»“æ„.</p><p>å…¶å®šä¹‰åœ¨src/server.hä¸­, å¦‚ä¸‹:</p><div class="language-cgo line-numbers-mode" data-ext="cgo"><pre class="language-cgo"><code>/* ZSETs use a specialized version of Skiplists */
typedef struct zskiplistNode {
    sds ele;
    double score;
    struct zskiplistNode *backward;
    struct zskiplistLevel {
        struct zskiplistNode *forward;
        unsigned int span;
    } level[];
} zskiplistNode;

typedef struct zskiplist {
    struct zskiplistNode *header, *tail;
    unsigned long length;
    int level;
} zskiplist;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾:</p><figure><img src="/assets/668722-20180910184047816-693646977-f9c0c3f6.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>zskiplistçš„æ ¸å¿ƒè®¾è®¡è¦ç‚¹ä¸º:</p><ol><li>å¤´ç»“ç‚¹ä¸æŒæœ‰ä»»ä½•æ•°æ®, ä¸”å…¶level[]çš„é•¿åº¦ä¸º32</li><li>æ¯ä¸ªç»“ç‚¹, é™¤äº†æŒæœ‰æ•°æ®çš„eleå­—æ®µ, è¿˜æœ‰ä¸€ä¸ªå­—æ®µscore, å…¶æ ‡ç¤ºç€ç»“ç‚¹çš„å¾—åˆ†, ç»“ç‚¹ä¹‹é—´å‡­å€Ÿå¾—åˆ†æ¥åˆ¤æ–­å…ˆåé¡ºåº, è·³è·ƒè¡¨ä¸­çš„ç»“ç‚¹æŒ‰ç»“ç‚¹çš„å¾—åˆ†å‡åºæ’åˆ—.</li><li>æ¯ä¸ªç»“ç‚¹æŒæœ‰ä¸€ä¸ªbackwardæŒ‡é’ˆ, è¿™æ˜¯åŸç‰ˆè·³è·ƒè¡¨ä¸­æ‰€æ²¡æœ‰çš„. è¯¥æŒ‡é’ˆæŒ‡å‘ç»“ç‚¹çš„å‰ä¸€ä¸ªç´§é‚»ç»“ç‚¹.</li><li>æ¯ä¸ªç»“ç‚¹ä¸­æœ€å¤šæŒæœ‰32ä¸ªzskiplistLevelç»“æ„. å®é™…æ•°é‡åœ¨ç»“ç‚¹åˆ›å»ºæ—¶, æŒ‰å¹‚æ¬¡å®šå¾‹éšæœºç”Ÿæˆ(ä¸è¶…è¿‡32). æ¯ä¸ªzskiplistLevelä¸­æœ‰ä¸¤ä¸ªå­—æ®µ.</li><li>forwardå­—æ®µæŒ‡å‘æ¯”è‡ªå·±å¾—åˆ†é«˜çš„æŸä¸ªç»“ç‚¹(ä¸ä¸€å®šæ˜¯ç´§é‚»çš„), å¹¶ä¸”, è‹¥å½“å‰zskiplistLevelå®ä¾‹åœ¨level[]ä¸­çš„ç´¢å¼•ä¸ºX, åˆ™å…¶forwardå­—æ®µæŒ‡å‘çš„ç»“ç‚¹, å…¶level[]å­—æ®µçš„å®¹é‡è‡³å°‘æ˜¯X+1. è¿™ä¹Ÿæ˜¯ä¸Šå›¾ä¸­, ä¸ºä»€ä¹ˆforwardæŒ‡é’ˆæ€»æ˜¯ç”»çš„æ°´å¹³çš„åŸå› .</li><li>spanå­—æ®µä»£è¡¨forwardå­—æ®µæŒ‡å‘çš„ç»“ç‚¹, è·ç¦»å½“å‰ç»“ç‚¹çš„è·ç¦». ç´§é‚»çš„ä¸¤ä¸ªç»“ç‚¹ä¹‹é—´çš„è·ç¦»å®šä¹‰ä¸º1.</li><li>zskiplistä¸­æŒæœ‰å­—æ®µlevel, ç”¨ä»¥è®°å½•æ‰€æœ‰ç»“ç‚¹(é™¤è¿‡å¤´ç»“ç‚¹å¤–), level[]æ•°ç»„æœ€é•¿çš„é•¿åº¦.</li></ol><p>è·³è·ƒè¡¨ä¸»è¦ç”¨äº, åœ¨ç»™å®šä¸€ä¸ªåˆ†å€¼çš„æƒ…å†µä¸‹, æŸ¥æ‰¾ä¸è¯¥åˆ†å€¼æœ€æ¥è¿‘çš„ç»“ç‚¹. æœç´¢æ—¶, ä¼ªä»£ç å¦‚ä¸‹:</p><div class="language-cgo line-numbers-mode" data-ext="cgo"><pre class="language-cgo"><code>int level = zskiplist-&gt;level - 1;
zskiplistNode p = zskiplist-&gt;head;

while(1 &amp;&amp; p)
{
    zskiplistNode q = (p-&gt;level)[level]-&gt;forward:
    if(q-&gt;score &gt; åˆ†å€¼)
    {
        if(level &gt; 0)
        {
            level--;
        }
        else
        {
            return :
                qä¸ºæ•´ä¸ªè·³è·ƒè¡¨ä¸­, åˆ†å€¼å¤§äºæŒ‡å®šåˆ†å€¼çš„ç¬¬ä¸€ä¸ªç»“ç‚¹
                q-&gt;backwardä¸ºæ•´ä¸ªè·³è·ƒè¡¨ä¸­, åˆ†å€¼å°äºæˆ–ç­‰äºæŒ‡å®šåˆ†å€¼çš„æœ€åä¸€ä¸ªç»“ç‚¹
        }
    }
    else
    {
        p = q;
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è·³è·ƒè¡¨çš„å®ç°æ¯”è¾ƒç®€å•, æœ€å¤æ‚çš„æ“ä½œå³æ˜¯æ’å…¥ä¸åˆ é™¤ç»“ç‚¹, éœ€è¦ä»”ç»†å¤„ç†é‚»è¿‘ç»“ç‚¹çš„æ‰€æœ‰level[]ä¸­çš„æ‰€æœ‰zskiplistLevelç»“ç‚¹ä¸­çš„forwardä¸spançš„å€¼çš„å˜æ›´.</p><p>å¦å¤–, å…³äºæ–°åˆ›å»ºçš„ç»“ç‚¹, å…¶<code>level[]</code>æ•°ç»„é•¿åº¦çš„éšæœºç®—æ³•, åœ¨æ¥å£zslInsertçš„å®ç°ä¸­, æ ¸å¿ƒä»£ç ç‰‡æ–­å¦‚ä¸‹:</p><div class="language-cgo line-numbers-mode" data-ext="cgo"><pre class="language-cgo"><code>zskiplistNode *zslInsert(zskiplist *zsl, double score, sds ele) {
    //...

    level = zslRandomLevel();   // éšæœºç”Ÿæˆæ–°ç»“ç‚¹çš„, level[]æ•°ç»„çš„é•¿åº¦
        if (level &gt; zsl-&gt;level) {   
        // è‹¥ç”Ÿæˆçš„æ–°ç»“ç‚¹çš„level[]æ•°ç»„çš„é•¿åº¦æ¯”å½“å‰è¡¨ä¸­æ‰€æœ‰ç»“ç‚¹çš„level[]çš„é•¿åº¦éƒ½å¤§
        // é‚£ä¹ˆå¤´ç»“ç‚¹ä¸­éœ€è¦æ–°å¢å‡ ä¸ªæŒ‡å‘è¯¥ç»“ç‚¹çš„æŒ‡é’ˆ
        // å¹¶åˆ·æ–°ziplistä¸­çš„levelå­—æ®µ
        for (i = zsl-&gt;level; i &lt; level; i++) {
            rank[i] = 0;
            update[i] = zsl-&gt;header;
            update[i]-&gt;level[i].span = zsl-&gt;length;
        }
        zsl-&gt;level = level;
    }
    x = zslCreateNode(level,score,ele); // åˆ›å»ºæ–°ç»“ç‚¹
    //... æ‰§è¡Œæ’å…¥æ“ä½œ
}

// æŒ‰å¹‚æ¬¡å®šå¾‹ç”Ÿæˆå°äº32çš„éšæœºæ•°çš„å‡½æ•°
// å® ZSKIPLIST_MAXLEVEL çš„å®šä¹‰ä¸º32, å® ZSKIPLIST_P è¢«è®¾å®šä¸º 0.25
// å³ 
//      level == 1çš„æ¦‚ç‡ä¸º 75%
//      level == 2çš„æ¦‚ç‡ä¸º 75% * 25%
//      level == 3çš„æ¦‚ç‡ä¸º 75% * 25% * 25%
//      ...
//      level == 31çš„æ¦‚ç‡ä¸º 0.75 * 0.25^30
//      è€Œ
//      level == 32çš„æ¦‚ç‡ä¸º 0.75 * sum(i = 31 ~ +INF){ 0.25^i }
int zslRandomLevel(void) {
    int level = 1;
    while ((random()&amp;0xFFFF) &lt; (ZSKIPLIST_P * 0xFFFF))
        level += 1;
    return (level&lt;ZSKIPLIST_MAXLEVEL) ? level : ZSKIPLIST_MAXLEVEL;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-5-intset" tabindex="-1"><a class="header-anchor" href="#_2-5-intset" aria-hidden="true">#</a> 2.5 intset</h3><p>è¿™æ˜¯ä¸€ä¸ªç”¨äºå­˜å‚¨åœ¨åºçš„æ•´æ•°çš„æ•°æ®ç»“æ„, ä¹Ÿåº•å±‚æ•°æ®ç»“æ„ä¸­æœ€ç®€å•çš„ä¸€ä¸ª, å…¶å®šä¹‰ä¸å®ç°åœ¨src/intest.hä¸src/intset.cä¸­, å…³é”®å®šä¹‰å¦‚ä¸‹:</p><div class="language-cgo line-numbers-mode" data-ext="cgo"><pre class="language-cgo"><code>typedef struct intset {
    uint32_t encoding;
    uint32_t length;
    int8_t contents[];
} intset;

#define INTSET_ENC_INT16 (sizeof(int16_t))
#define INTSET_ENC_INT32 (sizeof(int32_t))
#define INTSET_ENC_INT64 (sizeof(int64_t))
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>insetç»“æ„ä¸­çš„encodingçš„å–å€¼æœ‰ä¸‰ä¸ª, åˆ†åˆ«æ˜¯å®INTSET_ENC_INT16, INTSET_ENC_INT32, INTSET_ENC_INT64. lengthä»£è¡¨å…¶ä¸­å­˜å‚¨çš„æ•´æ•°çš„ä¸ªæ•°, contentsæŒ‡å‘å®é™…å­˜å‚¨æ•°å€¼çš„è¿ç»­å†…å­˜åŒºåŸŸ. å…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤º:</p><figure><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAysAAABXCAIAAACLPU0sAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA7EAAAOxAGVKw4bAAALeUlEQVR4nO3dcWiTdx7H8e9zjLkhXFl1dKMVVPL0RlYQi9ItYawnsjOpcBWkshWRITSTbaSU6l91FOwO5kpJmKIJFPGkf6wIl4HNU0bxhNGysqIUsv7R5OaByq6n9ujBcfP+ee6PPE/yZE1MUpNf2vp+4R/N7/n9fs+vLZZPf9/fk2qmaQoAAAAU+k2tFwAAAPDcIYEBAACoRgIDAABQ7YVaL0ApTdNqvYRq4TwfAAAbCHtgAAAAqpHAAAAAVCOBAQAAqEYCAwAAUI0EBgAAoFo5CcwIaFrAKHAl/wUAAACsUnoCMwJDCU+lbmsEvOFUpSYDAADYWEpNYKnwkAwMtFTorqnFRIVmAgAA2HhKTGDGl+Ndp33FOgU0i7XBlQp7c6uTqbDXGw4HNL13ZqZX1xxFzexYx4hsIzVOAACwiZSUwIzAkPtq0PXUPokhb6zTTEt2jesBQ8QVHOiJxrLhyfiyt2UgGIyYyZDHE0qaphnxpefXhtxJe7B7KB24jIA/EUq3xsVPBgMAAJtGCQksFR6SgSL5S0S6rkbsTbJs8vKdDiUyEcyIRXs682ykGbFEKBvwnLGtpTnd6ouYkWI7cAAAABtF8QRWUgEyG5bSfJ09icWUiLg6uhJD4ZSIpMJDiVC+iVKLiXRJ0uaPSmIxJb7ToYQ/W9IEAADYLIolsFIKkE/lCg60jE+kJDUxLl0dBSbyhOwapGU66BJxBadN0zSvyglOggEAgM2kSAIzYlHH/pQ/KlF/gTCU3vJyjMtsivk6W8YnjInxlgKlTFdzy8xCsvAaXMFpM55zngwAAGBDK5LAfBHnzlS8R3riZv4jWTO9JzLVQiPgd5748nW29Pp7W3KPgDlCl6+zJ+rPeQLSG07lvMurEYt63HqZnxoAAMA6VZG/SpRaTHhC8a5xe7PML/GcmKa7PZ6cI2Cuji5PNHvGyxcx4+K3d9qG3MnpoEt8kWyb33lUHwAAYIPTTNOs8i1SYa++MLAuHmbUNK3WS6iW6n8fAQBAxVT3L3Onwl5N08e7kushfgEAAKwTCvbA1hH2wAAAwHrwfCUwAACA9aC6VUgAAACsRgIDAABQjQQGAACgGgkMAABANRIYAACAaiQwAAAA1UhgAAAAqpHAAAAAVCOBAQAAqEYCAwAAUI0EBgAAoBoJDAAAQDUSGAAAgGokMAAAANVIYAAAAKqRwAAAAFQjgQEAAKhGAgMAAFCNBAYAAKAaCQwAAEA1EhgAAIBqJDAAAADVSGAAAACqkcAAAABUI4EBAACoRgIDAABQjQQGAACgGgkMAABANRIYAACAaiQwAAAA1UhgAAAAqpHAAAAAVCOBAQAAqEYCAwAAUI0EBgAAoBoJDAAAQLUXar0ApZY/a631Eqpi8o3+Wi+hKj5o7K71EgAAWJN3zadfZw8MAABANRIYAACAaiQwAAAA1UhgAAAAqpHAAAAAVCuawIyAFjBUrGSzW3546MrDuyIiK33n7k1V6zbzo92j89WaPG1pcnBwcqm69wAAYHMrmsB8ETPie3oXI+ANp9Zy8zUP3NjqRs7uOFjrRZRnfpTMBWwes+K9XrvhAESkIlXI1GJC8UAotvTzvVovAUDFpJ7tP/QzDgeQVnoVMhX2BgwxAlqatXtlBDS9d2amV9c0q1+mh7N6mW20W1cPVG9q4s62c+l/mbLgk8tX7k3JSp/Vvnh5OdP9yeUrdn+rnigicnd20Z7kzraJlQLzO+fJVCGfcq/csalMBbM886PdtkxpcmlycHQ+eyVnb8vRf3By3io2zo92911LJq/1OWeRAjMAqKrwx6K1i9Yu2seSqSCkrtuN7aIN53Q2RAL2pfADERFjWPQLMnNBtHYJzFo9jeHsDEaZw7NjHbcGUFR574kfC8Q6TTMikgp79RPhjumgL2Im3d4TcnU66BIRMQL+RChpBl1WdjMjPjEC2pA7aZouEZFU2KsFxIz8eqByUxN3hre7H5/dIiKy/PDQuXtiFwfjE//2n907InJ3dnHfNw//8OGru0SmJhZibvfjD7ekx56a/e1k25a7s4v7Fl6ZO9u8y55z28Tuxx116Y+Pye7HZ+us+S/e/6GpafUyCtzLMVZW+s79lHfs082Pdv+lcWRsrEFEZGlysHtUxk7uERGRudG5fWNjJ0WWJgf7Lk3uHTzUIDI/2n1ezoyN7bFHn0/qx0Vkz8mxkcbBS3Jq8FBDZvLvL80dWTUDgKoyhmX892JetD4+cV2mj0rquuh/leQtcdl9tGEx7T+TERuWzlsSEUldF/1P0nFRfP2S3CknRKaPZqcd2inmLREReSDedpFb4itx+Kz471p3N4YlMCuRNlVfDmCDK6sKGZVO60yYq6PLM7OQzNurpTn9g8A+QWbEEqGrmZjlCg70RGO1P9u/Ev9n06W2Ldar+lf7Wx/Frd8oH8nvrCi2S39l//1f/pbuf3t7v93/YMfeybYtIitfffvy1x++usue9GDH7hO3ly4vW/2/7qjLzH/pva35llHwXtmxUjfy/vbyP8H5uXvHT2VyUcOhIwduzlk7WDdlnxXFGva+pScf/CPd/+aBM1aziOw5eeZA4cmTO46sngFAdcVuyIAdm3z9Vgb68oLEL0rmF1lfv/TcsParRETesbKU623x/Ch5f2jH7spVe1pplIHDErP3xkoZLrusu/v6iV9AGcraA/O4dftDV3OLLOTp4jsdGtI1TTyhpLW5lVpMzPTqWm/uRCnx1Wbry7L8v4X79/edu+9s27/9ibhEZGtzvd1U/6JbfrH6N7306epJft1Y52/9Kb4sIr++tEt/ZX+eL1hp96p/aX8Zn5uIiCz9fC95ra/7mrNNb1ySPSKiN75mNzW8vkMeWP31xsPO3q816lJIvhkAVNUDSbwpp0to7DwssfsijSIi7szueaO0FJr2R9Hbc9o8O0XaShveJqE/i9Yunk+ym2oASlHxv8ztCk6bwXSxUZvpiZsRXRxxbD1pappzbF/ZntRiKdWhHx/JUxzk0BaAXG9K0rGLVq7gRQnaZ9F6vmAbDChVtd6R1RWcNuM90ZghruaWQvXKGqp/0W2V/J6hf57Glfjtrc31eS7dTf7rh7Xeq4yxGQ2v7yirOLiq/9Kd79fddw14njVKy+o6YL7G2A3H3tXapi2f66iYX0j0u2eeCHhuVCaBZSKW8/1bjVjU49ZFfJ09UX/2cUcjoGXfBax22azO3/roWPbRxZW+3EcR8/YfnrV2yKYm7hyafSJS9+l7/z3meEpxauKnq60NH9Wvmn/54alv/7PGtS0//OrRy2VXIWXPvgM3z2efXZwfLfLQYm7/pckbD3Y4q5Cc9QJqrvOwDNlvxGUMW2/KdfoT8TueizSGJXpYgo1Fppr5e860fsdjjIF2xzGyYsPTp++tj78Tz84iAwFkVKAK6ero8vT6tah4QsnpSDymaVr6gieUjLhExBcx4wFnq1WSzBmovEp5sGPv1xN3tp1Lv9r6+cfNH9U/vf/u+LmFbd+KiEjr7sdtW0RkV1vznCxmz5O1Wg9C5pn//SYp+bfDgx3uz68sWGObmub++NKpb0r/zCx7To6dGe3u7k6/yl+SzO0/cnywz+qvHx851XjpknWpYe9b+rXz3TfTs5S9EgAV4euXWLtoF0RE5LCYR0VEXEclKY6DXIezD0IW4npbPBdEu2Ed3vL1S3xYNHuG0FiRAJczPL2k9IU3JVns1gAyNNM0a70GdZY/a631EtbgyeUrC4vv7B0pnFEn36j4j72lycG+B0fGsg9H1sIHjd21vD0AAGv2bpF8VfGT+KiAqYk7x25nX+5/zz1Z/S3C+dHu8zezL/XjI4M1jV8AAGxi7IFtBlXYA1sX2AMDAGxUxfbAnq8EBgAAsB5U690oAAAAUAgJDAAAQDUSGAAAgGokMAAAANVIYAAAAKr9HzcqfOmmhaj0AAAAAElFTkSuQmCC" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>intsetä¸­å„å­—æ®µ, åŒ…æ‹¬contentsä¸­å­˜å‚¨çš„æ•°å€¼, éƒ½æ˜¯ä»¥ä¸»æœºåº(å°ç«¯å­—èŠ‚åº)å­˜å‚¨çš„. è¿™æ„å‘³ç€Redisè‹¥è¿è¡Œåœ¨PPCè¿™æ ·çš„å¤§ç«¯å­—èŠ‚åºçš„æœºå™¨ä¸Šæ—¶, å­˜å–æ•°æ®éƒ½ä¼šæœ‰é¢å¤–çš„å­—èŠ‚åºè½¬æ¢å¼€é”€</li><li>å½“encoding == INTSET_ENC_INT16æ—¶, contentsä¸­ä»¥int16_tçš„å½¢å¼å­˜å‚¨ç€æ•°å€¼. ç±»ä¼¼çš„, å½“encoding == INTSET_ENC_INT32æ—¶, contentsä¸­ä»¥int32_tçš„å½¢å¼å­˜å‚¨ç€æ•°å€¼.</li><li>ä½†å‡¡æœ‰ä¸€ä¸ªæ•°å€¼å…ƒç´ çš„å€¼è¶…è¿‡äº†int32_tçš„å–å€¼èŒƒå›´, æ•´ä¸ªintsetéƒ½è¦è¿›è¡Œå‡çº§, å³æ‰€æœ‰çš„æ•°å€¼éƒ½éœ€è¦ä»¥int64_tçš„å½¢å¼å­˜å‚¨. æ˜¾ç„¶å‡çº§çš„å¼€é”€æ˜¯å¾ˆå¤§çš„.</li><li>intsetä¸­çš„æ•°å€¼æ˜¯ä»¥å‡åºæ’åˆ—å­˜å‚¨çš„, æ’å…¥ä¸åˆ é™¤çš„å¤æ‚åº¦å‡ä¸ºO(n). æŸ¥æ‰¾ä½¿ç”¨äºŒåˆ†æ³•, å¤æ‚åº¦ä¸ºO(log_2(n))</li><li>intsetçš„ä»£ç å®ç°ä¸­, ä¸é¢„ç•™ç©ºé—´, å³æ¯ä¸€æ¬¡æ’å…¥æ“ä½œéƒ½ä¼šè°ƒç”¨zreallocæ¥å£é‡æ–°åˆ†é…å†…å­˜. æ¯ä¸€æ¬¡åˆ é™¤ä¹Ÿä¼šè°ƒç”¨zreallocæ¥å£ç¼©å‡å ç”¨çš„å†…å­˜. çœæ˜¯çœäº†, ä½†å†…å­˜æ“ä½œçš„æ—¶é—´å¼€é”€ä¸Šå‡äº†.</li><li>intsetçš„ç¼–ç æ–¹å¼ä¸€ç»å‡çº§, ä¸ä¼šå†é™çº§.</li></ul><p>æ€»ä¹‹, intseté€‚åˆäºå¦‚ä¸‹æ•°æ®çš„å­˜å‚¨:</p><ul><li>æ‰€æœ‰æ•°æ®éƒ½ä½äºä¸€ä¸ªç¨³å®šçš„å–å€¼èŒƒå›´ä¸­. æ¯”å¦‚å‡ä½äºint16_tæˆ–int32_tçš„å–å€¼èŒƒå›´ä¸­</li><li>æ•°æ®ç¨³å®š, æ’å…¥åˆ é™¤æ“ä½œä¸é¢‘ç¹. èƒ½æ¥å—O(lgn)çº§åˆ«çš„æŸ¥æ‰¾å¼€é”€</li></ul><h3 id="_2-6-ziplist" tabindex="-1"><a class="header-anchor" href="#_2-6-ziplist" aria-hidden="true">#</a> 2.6 ziplist</h3><p>ziplistæ˜¯Redisåº•å±‚æ•°æ®ç»“æ„ä¸­, æœ€è‹Ÿçš„ä¸€ä¸ªç»“æ„. å®ƒçš„è®¾è®¡å®—æ—¨å°±æ˜¯: çœå†…å­˜, ä»ç‰™ç¼é‡Œçœå†…å­˜. è®¾è®¡æ€è·¯å’ŒTLVä¸€è‡´, ä½†ä¸ºäº†ä»ç‰™ç¼é‡ŒèŠ‚çœå†…å­˜, åšäº†å¾ˆå¤šé¢å¤–å·¥ä½œ.</p><p>ziplistçš„å†…å­˜å¸ƒå±€ä¸intsetä¸€æ ·: å°±æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´. ä½†åŒºåŸŸåˆ’åˆ†æ¯”è¾ƒå¤æ‚, æ¦‚è§ˆå¦‚ä¸‹å›¾:</p><figure><img src="data:image/png;base64,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" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>å’Œintsetä¸€æ ·, ziplistä¸­çš„æ‰€æœ‰å€¼éƒ½æ˜¯ä»¥å°ç«¯åºå­˜å‚¨çš„</li><li>zlbyteså­—æ®µçš„ç±»å‹æ˜¯uint32_t, è¿™ä¸ªå­—æ®µä¸­å­˜å‚¨çš„æ˜¯æ•´ä¸ªziplistæ‰€å ç”¨çš„å†…å­˜çš„å­—èŠ‚æ•°</li><li>zltailå­—æ®µçš„ç±»å‹æ˜¯uint32_t, å®ƒæŒ‡çš„æ˜¯ziplistä¸­æœ€åä¸€ä¸ªentryçš„åç§»é‡. ç”¨äºå¿«é€Ÿå®šä½æœ€åä¸€ä¸ªentry, ä»¥å¿«é€Ÿå®Œæˆpopç­‰æ“ä½œ</li><li>zllenå­—æ®µçš„ç±»å‹æ˜¯uint16_t, å®ƒæŒ‡çš„æ˜¯æ•´ä¸ªziplitä¸­entryçš„æ•°é‡. è¿™ä¸ªå€¼åªå 16ä½, æ‰€ä»¥è›‹ç–¼çš„åœ°æ–¹å°±æ¥äº†: å¦‚æœziplistä¸­entryçš„æ•°ç›®å°äº65535, é‚£ä¹ˆè¯¥å­—æ®µä¸­å­˜å‚¨çš„å°±æ˜¯å®é™…entryçš„å€¼. è‹¥ç­‰äºæˆ–è¶…è¿‡65535, é‚£ä¹ˆè¯¥å­—æ®µçš„å€¼å›ºå®šä¸º65535, ä½†å®é™…æ•°é‡éœ€è¦ä¸€ä¸ªä¸ªentryçš„å»éå†æ‰€æœ‰entryæ‰èƒ½å¾—åˆ°.</li><li>zlendæ˜¯ä¸€ä¸ªç»ˆæ­¢å­—èŠ‚, å…¶å€¼ä¸ºå…¨F, å³0xff. ziplistä¿è¯ä»»ä½•æƒ…å†µä¸‹, ä¸€ä¸ªentryçš„é¦–å­—èŠ‚éƒ½ä¸ä¼šæ˜¯255</li></ul><p>åœ¨ç”»å›¾å±•ç¤ºentryçš„å†…å­˜å¸ƒå±€ä¹‹å‰, å…ˆè®²ä¸€ä¸‹entryä¸­éƒ½å­˜å‚¨äº†å“ªäº›ä¿¡æ¯:</p><ul><li>æ¯ä¸ªentryä¸­å­˜å‚¨äº†å®ƒå‰ä¸€ä¸ªentryæ‰€å ç”¨çš„å­—èŠ‚æ•°. è¿™æ ·æ”¯æŒzipliståå‘éå†.</li><li>æ¯ä¸ªentryç”¨å•ç‹¬çš„ä¸€å—åŒºåŸŸ, å­˜å‚¨ç€å½“å‰ç»“ç‚¹çš„ç±»å‹: æ‰€è°“çš„ç±»å‹, åŒ…æ‹¬å½“å‰ç»“ç‚¹å­˜å‚¨çš„æ•°æ®æ˜¯ä»€ä¹ˆ(äºŒè¿›åˆ¶, è¿˜æ˜¯æ•°å€¼), å¦‚ä½•ç¼–ç (å¦‚æœæ˜¯æ•°å€¼, æ•°å€¼å¦‚ä½•å­˜å‚¨, å¦‚æœæ˜¯äºŒè¿›åˆ¶æ•°æ®, äºŒè¿›åˆ¶æ•°æ®çš„é•¿åº¦)</li><li>æœ€åå°±æ˜¯çœŸå®çš„æ•°æ®äº†</li></ul><p>entryçš„å†…å­˜å¸ƒå±€å¦‚ä¸‹æ‰€ç¤º:</p><figure><img src="data:image/png;base64,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" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><code>prevlen</code>å³æ˜¯&quot;å‰ä¸€ä¸ªentryæ‰€å ç”¨çš„å­—èŠ‚æ•°&quot;, å®ƒæœ¬èº«æ˜¯ä¸€ä¸ªå˜é•¿å­—æ®µ, è§„çº¦å¦‚ä¸‹:</p><ul><li>è‹¥å‰ä¸€ä¸ªentryå ç”¨çš„å­—èŠ‚æ•°å°äº 254, åˆ™prevlenå­—æ®µå ä¸€å­—èŠ‚</li><li>è‹¥å‰ä¸€ä¸ªentryå ç”¨çš„å­—èŠ‚æ•°ç­‰äºæˆ–å¤§äº 254, åˆ™prevlenå­—æ®µå äº”å­—èŠ‚: ç¬¬ä¸€ä¸ªå­—èŠ‚å€¼ä¸º 254, å³0xfe, å¦å¤–å››ä¸ªå­—èŠ‚, ä»¥uint32_tå­˜å‚¨ç€å€¼.</li></ul><p><code>encoding</code>å­—æ®µçš„è§„çº¦å°±å¤æ‚äº†è®¸å¤š</p><ul><li>è‹¥æ•°æ®æ˜¯äºŒè¿›åˆ¶æ•°æ®, ä¸”äºŒè¿›åˆ¶æ•°æ®é•¿åº¦å°äº64å­—èŠ‚(ä¸åŒ…æ‹¬64), é‚£ä¹ˆencodingå ä¸€å­—èŠ‚. åœ¨è¿™ä¸€å­—èŠ‚ä¸­, é«˜ä¸¤ä½å€¼å›ºå®šä¸º0, ä½å…­ä½å€¼ä»¥æ— ç¬¦å·æ•´æ•°çš„å½¢å¼å­˜å‚¨ç€äºŒè¿›åˆ¶æ•°æ®çš„é•¿åº¦. å³ 00xxxxxx, å…¶ä¸­ä½å…­ä½bitxxxxxxæ˜¯ç”¨äºŒè¿›åˆ¶ä¿å­˜çš„æ•°æ®é•¿åº¦.</li><li>è‹¥æ•°æ®æ˜¯äºŒè¿›åˆ¶æ•°æ®, ä¸”äºŒè¿›åˆ¶æ•°æ®é•¿åº¦å¤§äºæˆ–ç­‰äº64å­—èŠ‚, ä½†å°äº16384(ä¸åŒ…æ‹¬16384)å­—èŠ‚, é‚£ä¹ˆencodingå ç”¨ä¸¤ä¸ªå­—èŠ‚. åœ¨è¿™ä¸¤ä¸ªå­—èŠ‚16ä½ä¸­, ç¬¬ä¸€ä¸ªå­—èŠ‚çš„é«˜ä¸¤ä½å›ºå®šä¸º01, å‰©ä½™çš„14ä¸ªä½, ä»¥å°ç«¯åºæ— ç¬¦å·æ•´æ•°çš„å½¢å¼å­˜å‚¨ç€äºŒè¿›åˆ¶æ•°æ®çš„é•¿åº¦, å³ 01xxxxxx, yyyyyyyy, å…¶ä¸­yyyyyyyyæ˜¯é«˜å…«ä½, xxxxxxæ˜¯ä½å…­ä½.</li><li>è‹¥æ•°æ®æ˜¯äºŒè¿›åˆ¶æ•°æ®, ä¸”äºŒè¿›åˆ¶æ•°æ®çš„é•¿åº¦å¤§äºæˆ–ç­‰äº16384å­—èŠ‚, ä½†å°äº2^32-1å­—èŠ‚, åˆ™encodingå ç”¨äº”ä¸ªå­—èŠ‚. ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯å›ºå®šå€¼10000000, å‰©ä½™å››ä¸ªå­—èŠ‚, æŒ‰å°ç«¯åºuint32_tçš„å½¢å¼å­˜å‚¨ç€äºŒè¿›åˆ¶æ•°æ®çš„é•¿åº¦. è¿™ä¹Ÿæ˜¯ziplistèƒ½å­˜å‚¨çš„äºŒè¿›åˆ¶æ•°æ®çš„æœ€å¤§é•¿åº¦, è¶…è¿‡2^32-1å­—èŠ‚çš„äºŒè¿›åˆ¶æ•°æ®, ziplistæ— æ³•å­˜å‚¨.</li><li>è‹¥æ•°æ®æ˜¯æ•´æ•°å€¼, åˆ™encodingå’Œdataçš„è§„çº¦å¦‚ä¸‹: <ol><li>é¦–å…ˆ, æ‰€æœ‰å­˜å‚¨æ•°å€¼çš„entry, å…¶encodingéƒ½ä»…å ç”¨ä¸€ä¸ªå­—èŠ‚. å¹¶ä¸”æœ€é«˜ä¸¤ä½å‡æ˜¯11</li><li>è‹¥æ•°å€¼å–å€¼èŒƒå›´ä½äº[0, 12]ä¸­, åˆ™encodingå’ŒdataæŒ¤åœ¨åŒä¸€ä¸ªå­—èŠ‚ä¸­. å³ä¸º1111 0001~1111 1101, é«˜å››ä½æ˜¯å›ºå®šå€¼, ä½å››ä½çš„å€¼ä»0001è‡³1101, åˆ†åˆ«ä»£è¡¨ 0 ~ 12è¿™åäº”ä¸ªæ•°å€¼</li><li>è‹¥æ•°å€¼å–å€¼èŒƒå›´ä½äº[-128, -1] [13, 127]ä¸­, åˆ™encoding == 0b 1111 1110. æ•°å€¼å­˜å‚¨åœ¨ç´§é‚»çš„ä¸‹ä¸€ä¸ªå­—èŠ‚, ä»¥int8_tå½¢å¼ç¼–ç </li><li>è‹¥æ•°å€¼å–å€¼èŒƒå›´ä½äº[-32768, -129] [128, 32767]ä¸­, åˆ™encoding == 0b 1100 0000. æ•°å€¼å­˜å‚¨åœ¨ç´§é‚»çš„åä¸¤ä¸ªå­—èŠ‚ä¸­, ä»¥å°ç«¯åºint16_tå½¢å¼ç¼–ç </li><li>è‹¥æ•°å€¼å–å€¼èŒƒå›´ä½äº[-8388608, -32769] [32768, 8388607]ä¸­, åˆ™encoding == 0b 1111 0000. æ•°å€¼å­˜å‚¨åœ¨ç´§é‚»çš„åä¸‰ä¸ªå­—èŠ‚ä¸­, ä»¥å°ç«¯åºå­˜å‚¨, å ç”¨ä¸‰ä¸ªå­—èŠ‚.</li><li>è‹¥æ•°å€¼å–å€¼èŒƒå›´ä½äº[-2^31, -8388609] [8388608, 2^31 - 1]ä¸­, åˆ™encoding == 0b 1101 0000. æ•°å€¼å­˜å‚¨åœ¨ç´§é‚»çš„åå››ä¸ªå­—èŠ‚ä¸­, ä»¥å°ç«¯åºint32_tå½¢å¼ç¼–ç </li><li>è‹¥æ•°å€¼å–å€¼å‡ä¸åœ¨ä¸Šè¿°èŒƒå›´, ä½†ä½äºint64_tæ‰€èƒ½è¡¨è¾¾çš„èŒƒå›´å†…, åˆ™encoding == 0b 1110 0000, æ•°å€¼å­˜å‚¨åœ¨ç´§é‚»çš„åå…«ä¸ªå­—èŠ‚ä¸­, ä»¥å°ç«¯åºint64_tå½¢å¼ç¼–ç </li></ol></li></ul><p>åœ¨å¤§è§„æ¨¡æ•°å€¼å­˜å‚¨ä¸­, ziplistå‡ ä¹ä¸æµªè´¹å†…å­˜ç©ºé—´, å…¶è‹Ÿçš„ç¨‹åºåˆ°è¾¾äº†å­—èŠ‚çº§åˆ«, ç”šè‡³å¯¹äº[0, 12]åŒºé—´çš„æ•°å€¼, è¿dataé‡Œçš„é‚£ä¸€ä¸ªå­—èŠ‚ä¹Ÿè¦çœä¸‹æ¥. æ˜¾ç„¶, ziplistæ˜¯ä¸€ç§ç‰¹åˆ«èŠ‚çœå†…å­˜çš„æ•°æ®ç»“æ„, ä½†å®ƒçš„ç¼ºç‚¹ä¹Ÿååˆ†æ˜æ˜¾:</p><ul><li>å’Œintsetä¸€æ ·, ziplistä¹Ÿä¸é¢„ç•™å†…å­˜ç©ºé—´, å¹¶ä¸”åœ¨ç§»é™¤ç»“ç‚¹å, ä¹Ÿæ˜¯ç«‹å³ç¼©å®¹, è¿™ä»£è¡¨æ¯æ¬¡å†™æ“ä½œéƒ½ä¼šè¿›è¡Œå†…å­˜åˆ†é…æ“ä½œ.</li><li>ziplistæœ€è›‹ç–¼çš„ä¸€ä¸ªé—®é¢˜æ˜¯: ç»“ç‚¹å¦‚æœæ‰©å®¹, å¯¼è‡´ç»“ç‚¹å ç”¨çš„å†…å­˜å¢é•¿, å¹¶ä¸”è¶…è¿‡254å­—èŠ‚çš„è¯, å¯èƒ½ä¼šå¯¼è‡´é“¾å¼ååº”: å…¶åä¸€ä¸ªç»“ç‚¹çš„entry.prevlenéœ€è¦ä»ä¸€å­—èŠ‚æ‰©å®¹è‡³äº”å­—èŠ‚. æœ€åæƒ…å†µä¸‹, ç¬¬ä¸€ä¸ªç»“ç‚¹çš„æ‰©å®¹, ä¼šå¯¼è‡´æ•´ä¸ªziplistè¡¨ä¸­çš„åç»­æ‰€æœ‰ç»“ç‚¹çš„entry.prevlenå­—æ®µæ‰©å®¹. è™½ç„¶è¿™ä¸ªå†…å­˜é‡åˆ†é…çš„æ“ä½œä¾ç„¶åªä¼šå‘ç”Ÿä¸€æ¬¡, ä½†ä»£ç ä¸­çš„æ—¶é—´å¤æ‚åº¦æ˜¯o(N)çº§åˆ«, å› ä¸ºé“¾å¼æ‰©å®¹åªèƒ½ä¸€æ­¥ä¸€æ­¥çš„è®¡ç®—. ä½†è¿™ç§æƒ…å†µçš„æ¦‚ç‡ååˆ†çš„å°, ä¸€èˆ¬æƒ…å†µä¸‹é“¾å¼æ‰©å®¹èƒ½è¿é”åæ˜ äº”å…­æ¬¡å°±å¾ˆä¸å¹¸äº†. ä¹‹æ‰€ä»¥è¯´è¿™æ˜¯ä¸€ä¸ªè›‹ç–¼é—®é¢˜, æ˜¯å› ä¸º, è¿™æ ·çš„ååœºæ™¯ä¸‹, å…¶å®æ—¶é—´å¤æ‚åº¦å¹¶ä¸é«˜: ä¾æ¬¡è®¡ç®—æ¯ä¸ªentryæ–°çš„ç©ºé—´å ç”¨, ä¹Ÿå°±æ˜¯o(N), æ€»ä½“å ç”¨è®¡ç®—å‡ºæ¥å, åªæ‰§è¡Œä¸€æ¬¡å†…å­˜é‡åˆ†é…, ä¸å¯¹åº”çš„memmoveæ“ä½œ, å°±å¯ä»¥äº†. è›‹ç–¼è¯´çš„æ˜¯: ä»£ç ç‰¹åˆ«éš¾å†™, éš¾è¯». ä¸‹é¢æ”¾ä¸€æ®µå¤„ç†æ’å…¥ç»“ç‚¹æ—¶å¤„ç†é“¾å¼ååº”çš„ä»£ç ç‰‡æ–­, å¤§å®¶è‡ªè¡Œæ„Ÿå—ä¸€ä¸‹:</li></ul><div class="language-cgo line-numbers-mode" data-ext="cgo"><pre class="language-cgo"><code>unsigned char *__ziplistInsert(unsigned char *zl, unsigned char *p, unsigned char *s, unsigned int slen) {
    size_t curlen = intrev32ifbe(ZIPLIST_BYTES(zl)), reqlen;
    unsigned int prevlensize, prevlen = 0;
    size_t offset;
    int nextdiff = 0;
    unsigned char encoding = 0;
    long long value = 123456789; /* initialized to avoid warning. Using a value
                                    that is easy to see if for some reason
                                    we use it uninitialized. */
    zlentry tail;

    /* Find out prevlen for the entry that is inserted. */
    if (p[0] != ZIP_END) {
        ZIP_DECODE_PREVLEN(p, prevlensize, prevlen);
    } else {
        unsigned char *ptail = ZIPLIST_ENTRY_TAIL(zl);
        if (ptail[0] != ZIP_END) {
            prevlen = zipRawEntryLength(ptail);
        }
    }

    /* See if the entry can be encoded */
    if (zipTryEncoding(s,slen,&amp;value,&amp;encoding)) {
        /* &#39;encoding&#39; is set to the appropriate integer encoding */
        reqlen = zipIntSize(encoding);
    } else {
        /* &#39;encoding&#39; is untouched, however zipStoreEntryEncoding will use the
         * string length to figure out how to encode it. */
        reqlen = slen;
    }
    /* We need space for both the length of the previous entry and
     * the length of the payload. */
    reqlen += zipStorePrevEntryLength(NULL,prevlen);
    reqlen += zipStoreEntryEncoding(NULL,encoding,slen);

    /* When the insert position is not equal to the tail, we need to
     * make sure that the next entry can hold this entry&#39;s length in
     * its prevlen field. */
    int forcelarge = 0;
    nextdiff = (p[0] != ZIP_END) ? zipPrevLenByteDiff(p,reqlen) : 0;
    if (nextdiff == -4 &amp;&amp; reqlen &lt; 4) {
        nextdiff = 0;
        forcelarge = 1;
    }

    /* Store offset because a realloc may change the address of zl. */
    offset = p-zl;
    zl = ziplistResize(zl,curlen+reqlen+nextdiff);
    p = zl+offset;

    /* Apply memory move when necessary and update tail offset. */
    if (p[0] != ZIP_END) {
        /* Subtract one because of the ZIP_END bytes */
        memmove(p+reqlen,p-nextdiff,curlen-offset-1+nextdiff);

        /* Encode this entry&#39;s raw length in the next entry. */
        if (forcelarge)
            zipStorePrevEntryLengthLarge(p+reqlen,reqlen);
        else
            zipStorePrevEntryLength(p+reqlen,reqlen);

        /* Update offset for tail */
        ZIPLIST_TAIL_OFFSET(zl) =
            intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+reqlen);

        /* When the tail contains more than one entry, we need to take
         * &quot;nextdiff&quot; in account as well. Otherwise, a change in the
         * size of prevlen doesn&#39;t have an effect on the *tail* offset. */
        zipEntry(p+reqlen, &amp;tail);
        if (p[reqlen+tail.headersize+tail.len] != ZIP_END) {
            ZIPLIST_TAIL_OFFSET(zl) =
                intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+nextdiff);
        }
    } else {
        /* This element will be the new tail. */
        ZIPLIST_TAIL_OFFSET(zl) = intrev32ifbe(p-zl);
    }

    /* When nextdiff != 0, the raw length of the next entry has changed, so
     * we need to cascade the update throughout the ziplist */
    if (nextdiff != 0) {
        offset = p-zl;
        zl = __ziplistCascadeUpdate(zl,p+reqlen);
        p = zl+offset;
    }

    /* Write the entry */
    p += zipStorePrevEntryLength(p,prevlen);
    p += zipStoreEntryEncoding(p,encoding,slen);
    if (ZIP_IS_STR(encoding)) {
        memcpy(p,s,slen);
    } else {
        zipSaveInteger(p,value,encoding);
    }
    ZIPLIST_INCR_LENGTH(zl,1);
    return zl;
}

unsigned char *__ziplistCascadeUpdate(unsigned char *zl, unsigned char *p) {
    size_t curlen = intrev32ifbe(ZIPLIST_BYTES(zl)), rawlen, rawlensize;
    size_t offset, noffset, extra;
    unsigned char *np;
    zlentry cur, next;

    while (p[0] != ZIP_END) {
        zipEntry(p, &amp;cur);
        rawlen = cur.headersize + cur.len;
        rawlensize = zipStorePrevEntryLength(NULL,rawlen);

        /* Abort if there is no next entry. */
        if (p[rawlen] == ZIP_END) break;
        zipEntry(p+rawlen, &amp;next);

        /* Abort when &quot;prevlen&quot; has not changed. */
        if (next.prevrawlen == rawlen) break;

        if (next.prevrawlensize &lt; rawlensize) {
            /* The &quot;prevlen&quot; field of &quot;next&quot; needs more bytes to hold
             * the raw length of &quot;cur&quot;. */
            offset = p-zl;
            extra = rawlensize-next.prevrawlensize;
            zl = ziplistResize(zl,curlen+extra);
            p = zl+offset;

            /* Current pointer and offset for next element. */
            np = p+rawlen;
            noffset = np-zl;

            /* Update tail offset when next element is not the tail element. */
            if ((zl+intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))) != np) {
                ZIPLIST_TAIL_OFFSET(zl) =
                    intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+extra);
            }

            /* Move the tail to the back. */
            memmove(np+rawlensize,
                np+next.prevrawlensize,
                curlen-noffset-next.prevrawlensize-1);
            zipStorePrevEntryLength(np,rawlen);

            /* Advance the cursor */
            p += rawlen;
            curlen += extra;
        } else {
            if (next.prevrawlensize &gt; rawlensize) {
                /* This would result in shrinking, which we want to avoid.
                 * So, set &quot;rawlen&quot; in the available bytes. */
                zipStorePrevEntryLengthLarge(p+rawlen,rawlen);
            } else {
                zipStorePrevEntryLength(p+rawlen,rawlen);
            }

            /* Stop here, as the raw length of &quot;next&quot; has not changed. */
            break;
        }
    }
    return zl;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ç§ä»£ç çš„ç‰¹ç‚¹å°±æ˜¯: æœ€å¥½ç”±ä½œè€…å»ç»´æŠ¤, æœ€å¥½ä¸€æ¬¡æ€§å†™å¯¹. å› ä¸ºè¯»èµ·æ¥çœŸçš„è´¹åŠ², æ”¹èµ·æ¥ä¹Ÿå¾ˆè´¹åŠ².</p><h3 id="_2-7-quicklist" tabindex="-1"><a class="header-anchor" href="#_2-7-quicklist" aria-hidden="true">#</a> 2.7 quicklist</h3><p>å¦‚æœè¯´ziplistæ˜¯æ•´ä¸ªRedisä¸­ä¸ºäº†èŠ‚çœå†…å­˜, è€Œå†™çš„æœ€è‹Ÿçš„æ•°æ®ç»“æ„, é‚£ä¹ˆç§°quicklistå°±æ˜¯åœ¨æœ€è‹Ÿçš„åŸºç¡€ä¸Š, å†è‹Ÿäº†ä¸€å±‚. è¿™ä¸ªç»“æ„æ˜¯Redisåœ¨3.2ç‰ˆæœ¬åæ–°åŠ çš„, åœ¨3.2ç‰ˆæœ¬ä¹‹å‰, æˆ‘ä»¬å¯ä»¥è®², dictæ˜¯æœ€å¤æ‚çš„åº•å±‚æ•°æ®ç»“æ„, ziplistæ˜¯æœ€è‹Ÿçš„åº•å±‚æ•°æ®ç»“æ„. åœ¨3.2ç‰ˆæœ¬ä¹‹å, è¿™ä¸¤ä¸ªè®°å½•è¢«åŒåŒåˆ·æ–°äº†.</p><p>è¿™æ˜¯ä¸€ç§, ä»¥ziplistä¸ºç»“ç‚¹çš„, åŒç«¯é“¾è¡¨ç»“æ„. å®è§‚ä¸Š, quicklistæ˜¯ä¸€ä¸ªé“¾è¡¨, å¾®è§‚ä¸Š, é“¾è¡¨ä¸­çš„æ¯ä¸ªç»“ç‚¹éƒ½æ˜¯ä¸€ä¸ªziplist.</p><p>å®ƒçš„å®šä¹‰ä¸å®ç°åˆ†åˆ«åœ¨src/quicklist.hä¸src/quicklist.cä¸­, å…¶ä¸­å…³é”®å®šä¹‰å¦‚ä¸‹:</p><div class="language-cgo line-numbers-mode" data-ext="cgo"><pre class="language-cgo"><code>/* Node, quicklist, and Iterator are the only data structures used currently. */

/* quicklistNode is a 32 byte struct describing a ziplist for a quicklist.
 * We use bit fields keep the quicklistNode at 32 bytes.
 * count: 16 bits, max 65536 (max zl bytes is 65k, so max count actually &lt; 32k).
 * encoding: 2 bits, RAW=1, LZF=2.
 * container: 2 bits, NONE=1, ZIPLIST=2.
 * recompress: 1 bit, bool, true if node is temporarry decompressed for usage.
 * attempted_compress: 1 bit, boolean, used for verifying during testing.
 * extra: 12 bits, free for future use; pads out the remainder of 32 bits */
typedef struct quicklistNode {
    struct quicklistNode *prev;
    struct quicklistNode *next;
    unsigned char *zl;
    unsigned int sz;             /* ziplist size in bytes */
    unsigned int count : 16;     /* count of items in ziplist */
    unsigned int encoding : 2;   /* RAW==1 or LZF==2 */
    unsigned int container : 2;  /* NONE==1 or ZIPLIST==2 */
    unsigned int recompress : 1; /* was this node previous compressed? */
    unsigned int attempted_compress : 1; /* node can&#39;t compress; too small */
    unsigned int extra : 10; /* more bits to steal for future usage */
} quicklistNode;

/* quicklistLZF is a 4+N byte struct holding &#39;sz&#39; followed by &#39;compressed&#39;.
 * &#39;sz&#39; is byte length of &#39;compressed&#39; field.
 * &#39;compressed&#39; is LZF data with total (compressed) length &#39;sz&#39;
 * NOTE: uncompressed length is stored in quicklistNode-&gt;sz.
 * When quicklistNode-&gt;zl is compressed, node-&gt;zl points to a quicklistLZF */
typedef struct quicklistLZF {
    unsigned int sz; /* LZF size in bytes*/
    char compressed[];
} quicklistLZF;

/* quicklist is a 40 byte struct (on 64-bit systems) describing a quicklist.
 * &#39;count&#39; is the number of total entries.
 * &#39;len&#39; is the number of quicklist nodes.
 * &#39;compress&#39; is: -1 if compression disabled, otherwise it&#39;s the number
 *                of quicklistNodes to leave uncompressed at ends of quicklist.
 * &#39;fill&#39; is the user-requested (or default) fill factor. */
typedef struct quicklist {
    quicklistNode *head;
    quicklistNode *tail;
    unsigned long count;        /* total count of all entries in all ziplists */
    unsigned long len;          /* number of quicklistNodes */
    int fill : 16;              /* fill factor for individual nodes */
    unsigned int compress : 16; /* depth of end nodes not to compress;0=off */
} quicklist;

typedef struct quicklistIter {
    const quicklist *quicklist;
    quicklistNode *current;
    unsigned char *zi;
    long offset; /* offset in current ziplist */
    int direction;
} quicklistIter;

typedef struct quicklistEntry {
    const quicklist *quicklist;
    quicklistNode *node;
    unsigned char *zi;
    unsigned char *value;
    long long longval;
    unsigned int sz;
    int offset;
} quicklistEntry;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œå®šä¹‰äº†äº”ä¸ªç»“æ„ä½“:</p><ul><li>quicklistNode, å®è§‚ä¸Š, quicklistæ˜¯ä¸€ä¸ªé“¾è¡¨, è¿™ä¸ªç»“æ„æè¿°çš„å°±æ˜¯é“¾è¡¨ä¸­çš„ç»“ç‚¹. å®ƒé€šè¿‡zlå­—æ®µæŒæœ‰åº•å±‚çš„ziplist. ç®€å•æ¥è®², å®ƒæè¿°äº†ä¸€ä¸ªziplistå®ä¾‹</li><li>quicklistLZF, ziplistæ˜¯ä¸€æ®µè¿ç»­çš„å†…å­˜, ç”¨LZ4ç®—æ³•å‹ç¼©å, å°±å¯ä»¥åŒ…è£…æˆä¸€ä¸ªquicklistLZFç»“æ„. æ˜¯å¦å‹ç¼©quicklistä¸­çš„æ¯ä¸ªziplistå®ä¾‹æ˜¯ä¸€ä¸ªå¯é…ç½®é¡¹. è‹¥è¿™ä¸ªé…ç½®é¡¹æ˜¯å¼€å¯çš„, é‚£ä¹ˆquicklistNode.zlå­—æ®µæŒ‡å‘çš„å°±ä¸æ˜¯ä¸€ä¸ªziplistå®ä¾‹, è€Œæ˜¯ä¸€ä¸ªå‹ç¼©åçš„quicklistLZFå®ä¾‹</li><li>quicklist. è¿™å°±æ˜¯ä¸€ä¸ªåŒé“¾è¡¨çš„å®šä¹‰. head, tailåˆ†åˆ«æŒ‡å‘å¤´å°¾æŒ‡é’ˆ. lenä»£è¡¨é“¾è¡¨ä¸­çš„ç»“ç‚¹. countæŒ‡çš„æ˜¯æ•´ä¸ªquicklistä¸­çš„æ‰€æœ‰ziplistä¸­çš„entryçš„æ•°ç›®. fillå­—æ®µå½±å“ç€æ¯ä¸ªé“¾è¡¨ç»“ç‚¹ä¸­ziplistçš„æœ€å¤§å ç”¨ç©ºé—´, compresså½±å“ç€æ˜¯å¦è¦å¯¹æ¯ä¸ªziplistä»¥LZ4ç®—æ³•è¿›è¡Œè¿›ä¸€æ­¥å‹ç¼©ä»¥æ›´èŠ‚çœå†…å­˜ç©ºé—´.</li><li>quicklistIteræ˜¯ä¸€ä¸ªè¿­ä»£å™¨</li><li>quicklistEntryæ˜¯å¯¹ziplistä¸­çš„entryæ¦‚å¿µçš„å°è£…. quicklistä½œä¸ºä¸€ä¸ªå°è£…è‰¯å¥½çš„æ•°æ®ç»“æ„, ä¸å¸Œæœ›ä½¿ç”¨è€…æ„ŸçŸ¥åˆ°å…¶å†…éƒ¨çš„å®ç°, æ‰€ä»¥éœ€è¦æŠŠziplist.entryçš„æ¦‚å¿µé‡æ–°åŒ…è£…ä¸€ä¸‹.</li></ul><p>quicklistçš„å†…å­˜å¸ƒå±€å›¾å¦‚ä¸‹æ‰€ç¤º:</p><figure><img src="/assets/668722-20180910184206679-1690711957-5faded75.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ä¸‹é¢æ˜¯æœ‰å…³quicklistçš„æ›´å¤šé¢å¤–ä¿¡æ¯:</p><p>quicklist.fillçš„å€¼å½±å“ç€æ¯ä¸ªé“¾è¡¨ç»“ç‚¹ä¸­, ziplistçš„é•¿åº¦.</p><ol><li>å½“æ•°å€¼ä¸ºè´Ÿæ•°æ—¶, ä»£è¡¨ä»¥å­—èŠ‚æ•°é™åˆ¶å•ä¸ªziplistçš„æœ€å¤§é•¿åº¦. å…·ä½“ä¸º: <ol><li>-1 ä¸è¶…è¿‡4kb</li><li>-2 ä¸è¶…è¿‡ 8kb</li><li>-3 ä¸è¶…è¿‡ 16kb</li><li>-4 ä¸è¶…è¿‡ 32kb</li><li>-5 ä¸è¶…è¿‡ 64kb</li><li>å½“æ•°å€¼ä¸ºæ­£æ•°æ—¶, ä»£è¡¨ä»¥entryæ•°ç›®é™åˆ¶å•ä¸ªziplistçš„é•¿åº¦. å€¼å³ä¸ºæ•°ç›®. ç”±äºè¯¥å­—æ®µä»…å 16ä½, æ‰€ä»¥ä»¥entryæ•°ç›®é™åˆ¶ziplistçš„å®¹é‡æ—¶, æœ€å¤§å€¼ä¸º2^15ä¸ª</li></ol></li><li>quicklist.compressçš„å€¼å½±å“ç€quicklistNode.zlå­—æ®µæŒ‡å‘çš„æ˜¯åŸç”Ÿçš„ziplist, è¿˜æ˜¯ç»è¿‡å‹ç¼©åŒ…è£…åçš„quicklistLZF <ol><li>0 è¡¨ç¤ºä¸å‹ç¼©, zlå­—æ®µç›´æ¥æŒ‡å‘ziplist</li><li>1 è¡¨ç¤ºquicklistçš„é“¾è¡¨å¤´å°¾ç»“ç‚¹ä¸å‹ç¼©, å…¶ä½™ç»“ç‚¹çš„zlå­—æ®µæŒ‡å‘çš„æ˜¯ç»è¿‡å‹ç¼©åçš„quicklistLZF</li><li>2 è¡¨ç¤ºquicklistçš„é“¾è¡¨å¤´ä¸¤ä¸ª, ä¸æœ«ä¸¤ä¸ªç»“ç‚¹ä¸å‹ç¼©, å…¶ä½™ç»“ç‚¹çš„zlå­—æ®µæŒ‡å‘çš„æ˜¯ç»è¿‡å‹ç¼©åçš„quicklistLZF</li><li>ä»¥æ­¤ç±»æ¨, æœ€å¤§å€¼ä¸º2^16</li></ol></li><li>quicklistNode.encodingå­—æ®µ, ä»¥æŒ‡ç¤ºæœ¬é“¾è¡¨ç»“ç‚¹æ‰€æŒæœ‰çš„ziplistæ˜¯å¦ç»è¿‡äº†å‹ç¼©. 1ä»£è¡¨æœªå‹ç¼©, æŒæœ‰çš„æ˜¯åŸç”Ÿçš„ziplist, 2ä»£è¡¨å‹ç¼©è¿‡</li><li>quicklistNode.containerå­—æ®µæŒ‡ç¤ºçš„æ˜¯æ¯ä¸ªé“¾è¡¨ç»“ç‚¹æ‰€æŒæœ‰çš„æ•°æ®ç±»å‹æ˜¯ä»€ä¹ˆ. é»˜è®¤çš„å®ç°æ˜¯ziplist, å¯¹åº”çš„è¯¥å­—æ®µçš„å€¼æ˜¯2, ç›®å‰Redisæ²¡æœ‰æä¾›å…¶å®ƒå®ç°. æ‰€ä»¥å®é™…ä¸Š, è¯¥å­—æ®µçš„å€¼æ’ä¸º2</li><li>quicklistNode.recompresså­—æ®µæŒ‡ç¤ºçš„æ˜¯å½“å‰ç»“ç‚¹æ‰€æŒæœ‰çš„ziplistæ˜¯å¦ç»è¿‡äº†è§£å‹. å¦‚æœè¯¥å­—æ®µä¸º1å³ä»£è¡¨ä¹‹å‰è¢«è§£å‹è¿‡, ä¸”éœ€è¦åœ¨ä¸‹ä¸€æ¬¡æ“ä½œæ—¶é‡æ–°å‹ç¼©.</li></ol><p><code>quicklist</code>çš„å…·ä½“å®ç°ä»£ç ç¯‡å¹…å¾ˆé•¿, è¿™é‡Œå°±ä¸è´´ä»£ç ç‰‡æ–­äº†, ä»å†…å­˜å¸ƒå±€ä¸Šä¹Ÿèƒ½çœ‹å‡ºæ¥, ç”±äºæ¯ä¸ªç»“ç‚¹æŒæœ‰çš„ziplistæ˜¯æœ‰ä¸Šé™é•¿åº¦çš„, æ‰€ä»¥åœ¨ä¸æ“ä½œæ—¶è¦è€ƒè™‘çš„åˆ†æ”¯æƒ…å†µæ¯”è¾ƒå¤š. æƒ³æƒ³éƒ½è›‹ç–¼.</p><p>quicklistæœ‰è‡ªå·±çš„ä¼˜ç‚¹, ä¹Ÿæœ‰ç¼ºç‚¹, å¯¹äºä½¿ç”¨è€…æ¥è¯´, å…¶ä½¿ç”¨ä½“éªŒç±»ä¼¼äºçº¿æ€§æ•°æ®ç»“æ„, listä½œä¸ºæœ€ä¼ ç»Ÿçš„åŒé“¾è¡¨, ç»“ç‚¹é€šè¿‡æŒ‡é’ˆæŒæœ‰æ•°æ®, æŒ‡é’ˆå­—æ®µä¼šè€—è´¹å¤§é‡å†…å­˜. ziplistè§£å†³äº†è€—è´¹å†…å­˜è¿™ä¸ªé—®é¢˜. ä½†å¼•å…¥äº†æ–°çš„é—®é¢˜: æ¯æ¬¡å†™æ“ä½œæ•´ä¸ªziplistçš„å†…å­˜éƒ½éœ€è¦é‡åˆ†é…. quickliståœ¨ä¸¤è€…ä¹‹é—´åšäº†ä¸€ä¸ªå¹³è¡¡. å¹¶ä¸”ä½¿ç”¨è€…å¯ä»¥é€šè¿‡è‡ªå®šä¹‰quicklist.fill, æ ¹æ®å®é™…ä¸šåŠ¡æƒ…å†µ, ç»éªŒä¸»ä¹‰è°ƒå‚.</p><h3 id="_2-8-zipmap" tabindex="-1"><a class="header-anchor" href="#_2-8-zipmap" aria-hidden="true">#</a> 2.8 zipmap</h3><p>dictä½œä¸ºå­—å…¸ç»“æ„, ä¼˜ç‚¹å¾ˆå¤š, æ‰©å±•æ€§å¼ºæ‚, æ”¯æŒå¹³æ»‘æ‰©å®¹ç­‰ç­‰, ä½†å¯¹äºå­—å…¸ä¸­çš„é”®å€¼å‡ä¸ºäºŒè¿›åˆ¶æ•°æ®, ä¸”é•¿åº¦éƒ½å¾ˆå°æ—¶, dictçš„ä¸­çš„ä¸€å¨æŒ‡é’ˆä¼šæµªè´¹ä¸å°‘å†…å­˜, å› æ­¤Redisåˆå®ç°äº†ä¸€ä¸ªè½»é‡çº§çš„å­—å…¸, å³ä¸ºzipmap.</p><p>zipmapé€‚åˆä½¿ç”¨çš„åœºåˆæ˜¯:</p><ul><li>é”®å€¼å¯¹é‡ä¸å¤§, å•ä¸ªé”®, å•ä¸ªå€¼é•¿åº¦å°</li><li>é”®å€¼å‡æ˜¯äºŒè¿›åˆ¶æ•°æ®, è€Œä¸æ˜¯å¤åˆç»“æ„æˆ–å¤æ‚ç»“æ„. dictæ”¯æŒå„ç§åµŒå¥—, å­—å…¸æœ¬èº«å¹¶ä¸æŒæœ‰æ•°æ®, è€Œä»…æŒæœ‰æ•°æ®çš„æŒ‡é’ˆ. ä½†zipmapæ˜¯ç›´æ¥æŒæœ‰æ•°æ®çš„.</li></ul><p>zipmapçš„å®šä¹‰ä¸å®ç°åœ¨src/zipmap.hä¸src/zipmap.cä¸¤ä¸ªæ–‡ä»¶ä¸­, å…¶å®šä¹‰ä¸å®ç°å‡æœªå®šä¹‰ä»»ä½•structç»“æ„ä½“, å› ä¸ºzipmapçš„å†…å­˜å¸ƒå±€å°±æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´. å…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹æ‰€ç¤º:</p><figure><img src="/assets/668722-20180910184223910-1797391394-0c29f7e1.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>zipmapèµ·å§‹çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å­˜å‚¨çš„æ˜¯zipmapä¸­é”®å€¼å¯¹çš„ä¸ªæ•°. å¦‚æœé”®å€¼å¯¹çš„ä¸ªæ•°å¤§äº254çš„è¯, é‚£ä¹ˆè¿™ä¸ªå­—èŠ‚çš„å€¼å°±æ˜¯å›ºå®šå€¼254, çœŸå®çš„é”®å€¼å¯¹ä¸ªæ•°éœ€è¦éå†æ‰èƒ½è·å¾—.</li><li>zipmapçš„æœ€åä¸€ä¸ªå­—èŠ‚æ˜¯å›ºå®šå€¼0xFF</li><li>zipmapä¸­çš„æ¯ä¸€ä¸ªé”®å€¼å¯¹, ç§°ä¸ºä¸€ä¸ªentry, å…¶å†…å­˜å ç”¨å¦‚ä¸Šå›¾, åˆ†åˆ«å…­éƒ¨åˆ†: <ol><li>len_of_key, ä¸€å­—èŠ‚æˆ–äº”å­—èŠ‚. å­˜å‚¨çš„æ˜¯é”®çš„äºŒè¿›åˆ¶é•¿åº¦. å¦‚æœé•¿åº¦å°äº254, åˆ™ç”¨1å­—èŠ‚å­˜å‚¨, å¦åˆ™ç”¨äº”ä¸ªå­—èŠ‚å­˜å‚¨, ç¬¬ä¸€ä¸ªå­—èŠ‚çš„å€¼å›ºå®šä¸º0xFE, åå››ä¸ªå­—èŠ‚ä»¥å°ç«¯åºuint32_tç±»å‹å­˜å‚¨ç€é”®çš„äºŒè¿›åˆ¶é•¿åº¦.</li><li>key_dataä¸ºé”®çš„æ•°æ®</li><li>len_of_val, ä¸€å­—èŠ‚æˆ–äº”å­—èŠ‚, å­˜å‚¨çš„æ˜¯å€¼çš„äºŒè¿›åˆ¶é•¿åº¦. ç¼–ç æ–¹å¼åŒlen_of_key</li><li>len_of_free, å›ºå®šå€¼1å­—èŠ‚, å­˜å‚¨çš„æ˜¯entryä¸­æœªä½¿ç”¨çš„ç©ºé—´çš„å­—èŠ‚æ•°. æœªä½¿ç”¨çš„ç©ºé—´å³ä¸ºå›¾ä¸­çš„free, å®ƒä¸€èˆ¬æ˜¯ç”±äºé”®å€¼å¯¹ä¸­çš„å€¼è¢«æ›¿æ¢å‘ç”Ÿçš„. æ¯”å¦‚, é”®å€¼å¯¹hello &lt;-&gt; wordè¢«ä¿®æ”¹ä¸ºhello &lt;-&gt; wå, å°±ç©ºäº†å››ä¸ªå­—èŠ‚çš„é—²ç½®ç©ºé—´</li><li>val_data, ä¸ºå€¼çš„æ•°æ®</li><li>free, ä¸ºé—²ç½®ç©ºé—´. ç”±äºlen_of_freeçš„å€¼æœ€å¤§åªèƒ½æ˜¯254, æ‰€ä»¥å¦‚æœå€¼çš„å˜æ›´å¯¼è‡´é—²ç½®ç©ºé—´å¤§äº254çš„è¯, zipmapå°±ä¼šå›æ”¶å†…å­˜ç©ºé—´.</li></ol></li></ul></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 1549169735@qq.com">xdc</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="vp-link nav-link prev" href="/redis/redis-basic.html"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->Redis åŸºç¡€</div></a><a class="vp-link nav-link next" href="/redis/redis-master-slave.html"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">Redisä¸»ä»å¤åˆ¶åŸç†<!----></div></a></nav><div id="comment" class="giscus-wrapper input-top" style="display:none;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">å¤‡æ¡ˆå·ï¼šçš–ICPå¤‡2023001912å·</div><div class="vp-copyright">Copyright Â© 2023-present ç è¯´256</div></footer></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-23d1540c.js" defer></script>
  </body>
</html>
